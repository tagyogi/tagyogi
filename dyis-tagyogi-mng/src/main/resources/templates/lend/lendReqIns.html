<!--
	파일정보 : lend/lendReqIns.html
	파일명 : lendReq
	업무명 : 대출신청 등록, 수정
	생성자 : 김대성
	생성일 : 2023-06-28
	
	//대출상품정보
	<th:block th:include="lend/comLendReqContr"></th:block> 
	
-->
<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="/layout/subLayout">
	<body>
		<th:block th:layout="comjs">
			<script th:src="@{/js/lendCom.js}"></script>
		</th:block>
		<script th:inline="javascript">
			
			/*<![CDATA[*/
			var codeList = /*[[${codeList}]]*/; //공통코드
			var gridColList = /*[[${gridColList}]]*/; //그리드옵션
			var gridOptList = []; //그리드옵션
			//var initParam = {codeList : "CM01:MB04:GR01:GR21", gridNoList : "40308:40202:40203:40204:40205", accYn : "Y"}
			
			var lendType = /*[[${menuInfo.refVal}]]*/; //메뉴참조값 (융자상품)
			var today = /*[[${today}]]*/
			
			//초기화 조회 콜백
			$(document).ready(function(){
				
				//화면 처리
				com.fnCodeSelectBox("LD05", "procStat", 1, "30", "1"); //처리상태
				com.fnCodeSelectBox("LD11", "interWay", 0, "10"); //이자산정방법
				
				//동적 첨부파일 (다건)
				com.fnIbsUpload($("#myUpload"));
				
				//조합계좌설정
				com.fnSetBankAccList("selBank", 1);	
				
				//IBsheet 초기화
				com.fnIbsInit(/*[[${menuInfo.workGrid}]]*/);
				
				//초기 데이터 설정 (id : 시트 객체 ID, el : 시트를 생성할 DIV객체 ID, options : 초기화 구문 변수, data : DATA)
			    IBSheet.create({ id: "sheetInter", el: "sheetDivInter", options: gridOptList[0] }); //이자정보
			    
			    //동적 융자상품정보설정
				lendCom.fnSetLendLimitView("LD01", "tbl_lendLimit"); 
				
				//상품별 명세현황
				fnLendContrViewSet(lendType);
				
				$("#procDt").val(/*[[${today}]]*/);
				
			});
			
			//조합원조회 콜백
			var fnMembInfoSet = function(resData){
				//console.log(resData)
				if(resData.lendContrNo === null || resData.lendContrNo === undefined){
					alert("융자한도 정보가 존재하지 않습니다.");
					$("#sMembNo").val("");
					$("#sMembNm").val("");
					return;
				}else{
					com.fnSetKeyVal(resData); //조합원 설정
					
					//한도정보조회
					var param = {contrNo : resData.lendContrNo}
					obj = {url:"/lendContr/selectLendContr.do", param:param, callBack:fnLendContrCallBack, msgYn:"N", sessYn:"Y", loadYn:"Y"};
					com.fnAjaxDef(obj);	
					
					//반환은행 조합원계좌로 재세팅
					var accParam = {paramId: "payBanks", sMembNo: $("#sMembNo").val(), sUseYn: "Y", choiceType: 1}
					com.fnSetMembAccList(accParam);
					
					if(obj.bankCd !== ""){
						$("#payBanks").val(obj.bankCd+","+obj.acctNo+","+obj.depoNm);
						$("#payBanks").trigger('change');
						//$("#payBank").val(obj.bankCd);
					} 
					
				}
				
				//알림톡세팅
				var setParam = {membNo: $("#sMembNo").val(), setTalk:"Y"}
				com.fnSetPersList(setParam);
			};
			
			//한도조회 콜백
			var fnLendContrCallBack = function(resData){
			//	console.log(resData);
					
				com.fnSetKeyVal(resData.contr, "ele_contrArea"); //한도정보설정

				$("#contrNo").val(resData.contr.contrNo); //약정번호
				$("#lendDt").val(resData.contr.contrBegDt); //약정시작일
				$("#repayPreDt").val(resData.contr.contrExpDt); //약정종료일
				$("#finalGrade").val(resData.contr.finalGrade); //신용도
				$("#ele_finalGrade").text(resData.grade); //신용도
				
				//동적 융자상품정보설정
				lendCom.fnSetLendLimitView("LD01", "tbl_lendLimit", resData.contr); 
				
				
				getLimit = resData.contr["limitAmt"+lendType];
				getUse = resData.contr["useAmt"+lendType];
				
				if(Number(getLimit) - Number(getUse) === 0){
					alert("잔여한도액이 0원 입니다.");
				}else{
					$("#lendAmt").val(Number(getLimit) - Number(getUse));
				}
			}
			
			//이자계산
			var fnInterCalc = function(){
				//alert($("#lendDt").val() +" /" + $("#repayPreDt").val() +" /" +  $("#lendAmt").val() +" /" + $("#interPer").val());
				lendCom.fnInterCalc();
			}
			
			//대출일자 입력
			var fnLendDtSet = function(){
				var lendDt = $("#lendDt").val();
				if(lendDt.length === 10){
					$("#repayPreDt").val(com.fnDateGet($("#lendDt").val(), 365)); //	
					
					//이자율 조회
					var param = {appDt : $("#lendDt").val(), membNo: $("#membNo").val(), finalGrade : $("#finalGrade").val(), lendType : lendType }
					obj = {url:"/membRateLend/selectLendRate.do", param:param, callBack:fnLendTypeSelCallBack, msgYn:"N", sessYn:"Y", loadYn:"Y"};
					com.fnAjaxDef(obj);
				}
			}
			
			//대출상품 선택 콜백
			var fnLendTypeSelCallBack = function(resData){
				if(lendType === "11"){
					$("#interPer").val(resData.data.conclusRate); //이율
				}else if(lendType === "12"){
					$("#interPer").val(resData.data.creditRate); //이율
				}else if(lendType === "13"){
					$("#interPer").val(resData.data.noteRate); //이율
				}else if(lendType === "14"){
					$("#interPer").val(resData.data.bondRate); //이율
				}else if(lendType === "15"){
					$("#interPer").val(resData.data.claimRate); //이율
			    }
			}
			
			//대출금액 입력
			var fnPayAmtCalc = function(val){
				var remainAmt = $("#remainAmt"+lendType).val();  //잔여액
				
				var lendAmt = com.rmComma($("#lendAmt").val()); //대출금액
				var repLendAmt = com.rmComma($("#repLendAmt").val()); //대체금액
				
				if(lendAmt === "") lendAmt = 0;
				if(repLendAmt === "") repLendAmt = 0;
				
				payAmt = lendAmt - repLendAmt;
				
				if(remainAmt < payAmt){
					alert("대출금액이 한도금액보다 큽니다.");
					$("#lendAmt").focus();
					return;
				}
			
				$("#payAmt").val(com.addComma(payAmt));
			}
			
			
			//저장
			var fnSave = function(){
				//필수체크
				var valChks = ["membNo", "contrDt", "contrBegDt", "contrExpDt", "contrNum"
							, "gradeNo", "lendType", "limitAmt", "lendDt", "repayPreDt"
							, "lendAmt", "interPer"];
				if(com.fnValChk(valChks)){
			
					fnPayAmtCalc(); //한도금액 체크	
				
					//지급 금액 설정
					if(confirm("저장 처리 하시겠습니까?")){
						var param = $("#saveFrm").serializeObject();
						param.inter = sheetInter.getSaveJson(0);
						
						if(lendType === "11"){ //계약진행자금대출 LD_MAS_CONCL (계약체결현황)
							param.conclus = sheetConcl.getSaveJson(0);
						}else if(lendType === "13"){ //어음할인 LD_MAS_NOTE (담보명세)
							param.note = sheetNote.getSaveJson(0);
						}else if(lendType === "14"){ //양도 매출재춴 및 대출신청 명세 LD_MAS_BOND 
							param.bond = sheetBond.getSaveJson(0);
						}else if(lendType === "15"){ //매출채권보험청구권 명세 LD_MAS_CLAIM, LD_MAS_BOND
							param.claim = sheetClaim.getSaveJson(0);
							param.bond = sheetBond.getSaveJson(0);
						}
						
						obj = {url:"/lend/insertLend.do", callBack:fnSaveCallBack, jParam:param, fileId:"myUpload", sessYn:"Y" };
						com.fnAjaxMulti(obj);
					}
					
				}	
				
			};
			
			//저장콜백
			var fnSaveCallBack = function(resData){
				if(resData.resultCode === 0){
					param = {menuCd:"1040201", paramMap:{}
					};
					parent.menuOpen(param);
					
					parent.closeMenu(/*[[${menuInfo.menuIdx}]]*/);	
				}
				
			};
			
			/*]]>*/
		    
		    
            
		</script>
		
		<!-- 콘텐츠 시작 -->
		<div class="contentsArea">
			<div class="contentsTop">
				<div th:insert="~{/fragments/subTitle}"></div>
				<div class="collapseCtrl">
					<button type="type" class="btn-collapse down"><span></span></button>
	<!--			<button type="type" class="btn-collapse close"><span></span></button>-->
					<button type="type" class="reLoadFrm"></button>
				</div>
			</div><!-- //contentsTop -->
			<form name="saveFrm" id="saveFrm" method="post" onSubmit="return false">
			<input type="hidden" name="atthType" id="atthType" th:value="${paramMap.atthType}"/>
			<input type="hidden" name="lendType" id="lendType" th:value="${menuInfo.refVal}"/>
			<input type="hidden" name="finalGrade" id="finalGrade" />
			<input type="hidden" name="membNo" id="membNo" value="" title="조합원"/>
			<input type="hidden" name="contrNo" id="contrNo" value="" title="약정번호"/>
			
			<div class="contents flex">
				<div class="layer-flex collapseArea">
					<!-- 그리드 좌측 부분 -->
					<div class="collapseBox" style="width:49%">
						<!--조합원조회 ######################################################################## -->
						<th:block th:include="com/comMembSearch"></th:block> <!--조합원조회 -->
						<!--조합원조회 ######################################################################## -->
						<!--융자약정정보 ######################################################################## -->
						<th:block th:include="lend/comLendContrDtl"></th:block> <!--융자약정정보 -->
						<!--융자약정정보 ######################################################################## -->
						<section class="area mt5">
							<div class="fl">
								<h4 class="title">융자상품정보</h4>
							</div>
						</section>
						<table class="tbl" id="tbl_lendLimit"></table>
						<!--대출상품정보 ######################################################################## -->
						<th:block th:include="lend/comLendReqContr"></th:block> <!--대출상품정보 -->
						<!--대출상품정보 ######################################################################## -->
						
					</div>
					
					<!-- 그리드 우측 부분 시작 -->
					<div class="collapseBox fixable" style="width:49%">
						<section class="area mt5">
							<div class="fl">
								<h4 class="title">대출이자정보</h4>
							</div>
							<div class="fr">
								<select name="interWay" id="interWay" title="이자산정방법" style="width:80px;" /></select>
								<button type="button" onclick="javascript:fnInterCalc();" class="btn small style08">계산</button>
							</div>
						</section>
						<div id="sheetDivInter" style="width:100%;height:320px"></div>
						
						<!--알림톡정보 : s-->
						<div id="alarmBox" class="wrapBox mt10">
							<th:block th:include="com/comAlarmTalk"></th:block> <!--알람톡정보 -->
							<!--<th:block th:include="com/comAlarmTalk :: type('invtSeprt')"></th:block> -->
						</div><!-- //wrapbox-->
						<!--알림톡정보 : e-->
						
						<section class="area mt10">
							<div class="fl">
								<h4 class="title">심사정보</h4>
							</div>
						</section>
						<table class="tbl">
							<colgroup>
								<col style="width:100px;">
								<col style="width:140px;">
								<col style="width:100px;">
								<col style="width:140px;">
								<col style="width:100px;">
								<col style="">
							</colgroup>
							<tbody>
								<tr>
									<th>처리상태</th>
									<td><select name="procStat" id="procStat" title="처리상태" style="width:120px"></select></td>
									<th>심사일자</th>
									<td>
										<input type="search" name="procDt" id="procDt" title="심사일자" onkeyup="com.fnOnlyNum(this);com.fnDateMakeForm(this)" onblur="com.fnDateValiChk(this);" style="width:100px" maxlength="10"/>
										<img src="../images/icon_calendar.png" class="calendar-box" onclick="calendar(this, 'procDt', 'yyyy-mm-dd','','')" />		
									</td>
									<th>심사자</th>
									<td>[[${session.userNm}]]</td>
								</tr>
								<tr>
									<th>처리사유</th>
									<td colspan="5">
										<input type="search" name="" id="" title="보증금액" maxlength="20" style="width:500px" value="" />
									</td>
								</tr>
							</tbody>
						</table>
						<!-- 첨부파일 -->
						<div class="wrapBox">
							<section class="area mt5">
								<div class="fl">
									<h4 class="title">첨부파일<span style="font-size: 11px; color: #ff6600">(첨부할 파일을 끌어다 놓으시거나, 마우스 오른쪽버튼 -> '추가'로 첨부바랍니다.)</span></h4>
								</div>
								<div class="fr">
		                           <button type="button" onclick="javascript:com.fnIbsFileAdd($('#myUpload'));" class="btn small style08">추가</button>
		                           <button type="button" onclick="javascript:com.fnIbsFileDel($('#myUpload'));" class="btn small style08">삭제</button>
		                    	</div>
							</section>
							<div></div>
							<div id="myUpload" style="height:150px;"></div>
						</div>
					</div>
					<!-- END 컨텐츠 영역 -->
				</div>
				<div class="layer-flex mt50">
					<!-- 처리 버튼 영역 -->
					<div class="" style="width:100%">	
						<section class="area">
							<div class="fc">
								<button type="button" onclick="javascript:fnSave();" class="btn style07">저장</button>
							</div>
						</section>
					</div>
					<!-- 처리 버튼 영역 끝-->
				</div>
			</div><!-- //contents -->
			</form>
		</div><!-- //contentsArea -->
	</body>
</html>
