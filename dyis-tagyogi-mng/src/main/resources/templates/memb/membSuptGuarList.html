<!--
   파일정보 : membGuarList.html
   파일명 : membGuar현황
   업무명 : (보증)연도/장르별 수수료 현황 현황 조회, 등록, 수정
   생성자 : 박재만
   생성일 : 2023-07-11
-->
<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="/layout/subLayout">
   <body>
      <script th:inline="javascript">
         /*<![CDATA[*/
         var codeList = /*[[${codeList}]]*/; //공통코드
         var gridColList = /*[[${gridColList}]]*/; //그리드옵션
         var gridOptList = []; //그리드옵션
         var excelCols = []; //엑셀 col
         
         //초기화 조회 콜백
         $(document).ready(function(){
            //화면 처리
            // 대상년도 배열로 셋팅
            var date = new Date(); // 현재날짜
            var sYear = date.getFullYear(); // 현재년도
            var month = (date.getMonth()+1) < 9 ? "0" + (date.getMonth()+1) : (date.getMonth()+1); // 현재 월
            var arr = [];
            var sArr = {};
            var htm = "";
            
            //엑셀 컬럼 이름초기값 세팅
            excelCols.push(gridColList[0].Name);
            
            for(var i=0; i<=10; i++) {
               sArr = {};
               if(i === 0) {
                  sArr[i] = sYear;
               } else {
                  sArr[i] = sYear - i;                  
               }
               arr.push(sArr);
            }
               
            for(var j=0; j<arr.length; j++) {
               htm += "<option value=" + arr[j][j] + ">" + arr[j][j] + "</option>";   
            }   
            $("#sYear").html(htm);
            $("#sMonth").val(month).prop("selected", true);
            
            //IBsheet 초기화
            com.fnIbsInit(/*[[${menuInfo.workGrid}]]*/);
               
            //초기 데이터 설정 (id : 시트 객체 ID, el : 시트를 생성할 DIV객체 ID, options : 초기화 구문 변수, data : DATA)
             IBSheet.create({ id: "sheet", el: "sheetDiv", options: gridOptList[0] });
             
             //시트 생성 이후 
             IBSheet.onRenderFirstFinishAll = function(obj){
				 
			   //그리드 고정
			   sheet.setFixedCols(2, 0, 1);
               fnSearch(); //조회 호출
            };
         });
         
         //현황 조회
         var fnSearch = function(){
            param = JSON.stringify($("#serchFrm").serializeObject());
            com.fnIbsSearch("/membSupt/selectMembGuarList.do", param, sheet, callback); //param, sheetId 생략 가능
         };

         // 현황 조회 콜백
         var callback = function(restData) {
            var obj = restData.parseData[0];
            var setObj = Object.keys(obj);
            var spliceObj = setObj.splice(10,2);

            fnAddCols(setObj);

            sheet.rerender();
            
            parent.$("#ele_loading").css("display","none"); //로딩바
         };
         
         // 그리드 동적 생성
         var fnAddCols = function(result) {
            var obj = result;
            for(var j=0; j < obj.length; j++) {
               sheet.addCol(obj[j], 1, -1, {Type:"Int",Header:obj[j],Width:130, MinWidth:130, FormulaRow:"Sum", Align: "Right", excelYn:"1"}, true, false );
               excelCols.push(obj[j]);
            }
            
         };

         //엑셀 다운로드
         var fnExcel = function(){
            
            /****************동적생성 excel 세팅 시작*****************/
           
            //동적생성 완료된 cols 이름만 전부 가져오기
            //var cols = sheet.getCols();
            //동적생성 완료된 cols 정보 다 가져오기 (넘겨야할 열의 정보들 세팅을 위해)
            var shCol = sheet.Cols;
            
            //넘길열의 정보 필터를 위해 넘길만큼의 cols와 배열세팅
            /*for(var c=0; c < cols.length; c++) {
               excelCols.push(cols[c]);
            };*/
            var colSize = excelCols.length;
            var keyArr = new Array(colSize).fill(0);
            
            //넘길 열의 배열 세팅시작
            $.each(shCol, function(idx, item){
               for(var a=0; a < excelCols.length; a++) {
                  if(excelCols[a] === idx) {
                     if(keyArr[idx] === undefined || keyArr[idx] === null || keyArr[idx] === "") {
                        keyArr[a] = item;
                     }
                  }
               }
            });
            
            /****************동적생성 excel 세팅 끝*****************/
            
            //console.log(gridOptList[0].Cols);
            com.fnExcelToJs(sheet, keyArr, "연도장르별 보증수수료_" + /*[[${today}]]*/); 
         };
         
         //검색 초기화
         var fnReset = function(){
            com.fnSerchInit("#serchFrm");
            var date = new Date(); // 현재날짜
            var month = (date.getMonth()+1) < 9 ? "0" + (date.getMonth()+1) : (date.getMonth()+1); // 현재 월
            $("#sMonth").val(month).prop("selected", true);
            fnSearch();
         };
         
          /*]]>*/
      </script>
      
      <!-- 콘텐츠 시작 -->
      <div class="contentsArea">
         <div class="contentsTop">
            <div th:insert="~{/fragments/subTitle}"></div>
         </div><!-- //contentsTop -->
         <div class="contents flex">
            <!-- 검색 부분 -->
            <form name="serchFrm" id="serchFrm" method="post" onSubmit="return false">
            <section class="searchArea mt10">
               <div class="row">
                  <dl>
                     <dt>검색기간</dt>
                     <dd style="width:200px;">
                        <select name="sYear" id="sYear" style="width:80px;"></select>
                        <select name="sMonth" id="sMonth" style="width:80px;">
                           <option value="01">1</option>
                           <option value="02">2</option>
                           <option value="03">3</option>
                           <option value="04">4</option>
                           <option value="05">5</option>
                           <option value="06">6</option>
                           <option value="07">7</option>
                           <option value="08">8</option>
                           <option value="09">9</option>
                           <option value="10">10</option>
                           <option value="11">11</option>
                           <option value="12">12</option>
                        </select>
                     </dd>
                  </dl>
               </div><!-- //row -->
               
               <div class="searchBtn">
                  <button type="button" onclick="javascript:fnSearch();" class="btn search">조회</button>
                  <button type="button" onclick="javascript:fnReset();" class="btn reset">초기화</button>
               </div>
            </section>
            </form>
            <!-- 검색 부분 끝 -->
            <div class="layer-flex mt10">
               <!-- 그리드 좌측 부분 -->
               <div class="" style="width:100%">
                  <!-- 그리드 상단 부분 -->
                  <section class="area">
                     <div class="fr">
                        <button type="button" onclick="javascript:fnExcel();" class="btn style04">엑셀</button>
                     </div>
                  </section>
                  <!-- 그리드 상단 부분 끝 -->
                  <div class="mt10">
                      <div id="sheetDiv" style="width:100%;height:500px"></div>
                  </div>
               </div>
               <!-- 그리드 좌측 부분 끝 -->
                  
               <!-- END 컨텐츠 영역 -->
            </div>
         </div><!-- //contents -->
      </div><!-- //contentsArea -->
   </body>
</html>