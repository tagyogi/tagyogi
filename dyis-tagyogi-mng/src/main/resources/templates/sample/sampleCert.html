<!--
	파일정보 : sampleCert.html
	파일명 : 샘플 인증서
	업무명 : 공인인증서 샘플
	생성자 : DEV
	생성일 : 1900.01.01
-->
<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="/layout/subLayout">
	<body>
		<link rel="stylesheet" th:href="@{/CC_WSTD_home/unisignweb/rsrc/css/certcommon.css?v=1}" />
		<script th:src="@{/CC_WSTD_home/install/ObjectInstall.js}"></script>
		<script th:src="@{/CC_WSTD_home/unisignweb/js/unisignwebclient.js?v=1}"></script>
		<script th:src="@{/CC_WSTD_home/unisignweb/framework/json2.js}"></script>
		<script th:src="@{/CC_WSTD_home/UniSignWeb_Multi_Init_Nim.js?v=1}"></script>
		<script th:inline="javascript">
			/*<![CDATA[*/
			
			//공인인증서 설치 여부 체크
			
			var checker = UniCRSInstall({
				options: {
					callerName: 'checker' // 선언 변수명과 반드시 동일 해야 함!
				},
				success: function(){
					$("#certChk").text("공인인증서 모듈이 설치 되어있습니다.");
					//성공 (설치 체크 완료 )
					//마크애니 설치 체크 
					//maSetInstallPgTable();
					//maBrokerInit( maEPS_InstallCheck, 'getVersion', false );
					
				},
				fail: function(code, msg, detailmsg){
					//설치페이지 이동
					document.location.href = "/CC_WSTD_home/install/index.html";
				},
				progress: function(msg){
					//document.getElementById("next").innerHTML = msg;
				}
				
			});
			
			//모듈호출
			var fnCert = function(){
				var valChks = ["idn", "plainText"];
				
				if(com.fnValChk(valChks)){
					$("#rcVal").text("");
				
					unisign.SignDataNonEnveloped(  $("#plainText").val() , null, "", function( resultObject ) 
					{
						
						$("#signedText").text(resultObject.signedData); //결과출력
						if( !resultObject || resultObject.resultCode !==0 )
						{
							alert( resultObject.resultMessage + "\n오류코드 : " + resultObject.resultCode );
							return false;
						}
						
						//GetRValueFromKey(resultObject.certAttrs.subjectName);
						
						//R값 생성
						unisign.GetRValueFromKey(resultObject.certAttrs.subjectName, "", function( resultObject ) {
							
							if( !resultObject || resultObject.resultCode !== 0 ){
								alert( resultObject.resultMessage + "\n오류코드 : " + resultObject.resultCode );
								return;
							}
							
							$("#userR").val(resultObject.RValue); // R 값 
							
						})
					});
				}
				
				
			}
			
			//해쉬복호화
			var fnCertDec = function(){
				var valChks = ["signedText"];
				
				if(com.fnValChk(valChks)){
					unisign.VerifySignData($("#signedText").val(), function(rcCallBack){
						$("#rcVal").text(rcCallBack);
					});
				}
				
			}
			
			//인증서검증
			var fnCertVeri = function(){
				
				var valChks = ["userR"];
				
				if(com.fnValChk(valChks)){
					obj = {url:"/com/certVeri.do", formId:"serchFrm", callBack:fnCertVeriCallBack, msgYn:"N", sessYn:"Y", loadYn:"N"};
					com.fnAjaxPost(obj); 
				}
				
			}
			
			//인증서검증 콜백
			var fnCertVeriCallBack = function(resData){
				console.log(resData);
				//veriResult
				
				var html = "userDn : " + resData.paramMap.userDn;
				html += "\nserial : " + resData.paramMap.certSerial;
				html += "\ndate : " + resData.paramMap.staDt + " ~ " + resData.paramMap.endDt;
				html += "\nresult : " + resData.paramMap.certErrCode + " [ " + resData.paramMap.certErrMsg + " ]";

				$("#veriResult").html(html);
			}
			
			/*]]>*/
		</script>
		
		<!-- 콘텐츠 시작 -->
		<div class="contentsArea">
			<div th:insert="~{/fragments/subTitle}"></div>
			<div class="contents flex">
				<!-- 검색 부분 -->
				<form name="serchFrm" id="serchFrm" method="post" onSubmit="return false">
				<section class="searchArea mt10">
					<div class="row">
						<dl>
							<dt><div id="certChk"></div></dt>
						</dl>
					</div><!-- //row -->
					
				</section>
				
				<!-- 검색 부분 끝 -->
				
				<div class="layer-flex mt20">
					<!-- 내용 좌측 부분 -->
					<div class="" style="width:49%">
						<section class="area">
							<div class="fl">
								<h4 class="title">공인인증서(한국전자인증)</h4>
							</div>
							<div class="fr">
								<button id="btnIns" onclick="javascript:fnCert();" class="btn style08">모듈호출</button>
								<button id="btnUpt" onclick="javascript:fnCertDec();" class="btn style06">해쉬복호화</button>
								<button id="btnCan" onclick="javascript:fnCertVeri();" class="btn style06">검증</button>
							</div>
						</section>
						<!-- 상단 부분 끝 -->
						<table class="tbl mt10" >
							<colgroup>
								<col style="width:130px;">
								<col style="">
							</colgroup>
							<tbody>
								<tr>
									<th>식별번호(주민/사업자)</th>
									<td colspan="3">
										<input type="text" name="idn" id="idn" title="식별번호(주민/사업자)" style="width:300px"></textarea>
									</td>
								</tr>
								<tr>
									<th>서명원문</th>
									<td colspan="3">
										<textarea name="plainText" id="plainText" title="서명내용" cols="100" rows="3">서명원문영역이 있어야 진행이 가능합니다.</textarea>
									</td>
									
								</tr>
								<tr>
									<th>서명결과</th>
									<td colspan="3">
										<textarea name="signedText" id="signedText" title="서명결과" cols="100" rows="10"></textarea>
									</td>
								</tr>
								<tr>
									<th>R값</th>
									<td colspan="3">
										<input type="text" name="userR" id="userR" title="R값" style="width:300px"></textarea>
									</td>
								</tr>
							</tbody>
						</table>
					</div>
					<!-- 내용 좌측 부분 끝 -->
					<!-- 내용 우측 부분 -->
					<div class="" style="width:49%">
						<form name="procFrm" id="procFrm" method="post" onSubmit="return false">
						<!-- 상단 부분 -->
						<section class="area">
							<div class="fr">
							</div>
						</section>
						<!-- 상단 부분 끝 -->
						<table class="tbl mt10" >
							<colgroup>
								<col style="width:100px;">
								<col style="">
							</colgroup>
							<tbody>
								<tr>
									<th>서명복호화</th>
									<td colspan="3">
										<textarea name="rcVal" id="rcVal" title="검증" cols="100" rows="3"></textarea>
									</td>
								</tr>
								<tr>
									<th>검증결과</th>
									<td colspan="3">
										<textarea name="veriResult" id="veriResult" title="검증결과" cols="200" rows="10"></textarea>
									</td>
								</tr>
							</tbody>
						</table>
						</form>
					</div>	
					<!-- 내용 우측 부분 끝 -->
					<!-- END 컨텐츠 영역 -->
				</div>
				</form>
			</div><!-- //contents -->
		</div><!-- //contentsArea -->
	</body>
</html>