<!--
	파일정보 : kakaoList.html
	파일명 : 카카오채널관리
	업무명 : 카카오채널관리 현황 등록 폼
	생성자 : BSG
	생성일 : 2023.08.30
-->
<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="/layout/subLayout">
	<body>
		<script th:src="@{/markany/js/MaXHRControl.js}"></script>
		<script th:src="@{/js/ozws.js}"></script>
		<script th:src="@{/js/oz.js}"></script>
		<script th:inline="javascript">
			/*<![CDATA[*/
			var codeList = /*[[${codeList}]]*/; //공통코드
			var gridColList = /*[[${gridColList}]]*/; //그리드옵션
			var gridOptList = []; //그리드옵션

			//초기화 조회 콜백
			$(document).ready(function(){

				//INPUT 설정
				com.fnCodeSelectBox("CM23", "sWorkCd", 2, "" ); //업무구분
				com.fnCodeSelectBox("CM23", "workType", 1, "" ); //업무구분
				com.fnCodeSelectBox("SY02", "useYn", 1, "" ); //사용여부

				//IBsheet 초기화
				com.fnIbsInit(/*[[${menuInfo.workGrid}]]*/);

				//초기 데이터 설정 (id : 시트 객체 ID, el : 시트를 생성할 DIV객체 ID, options : 초기화 구문 변수, data : DATA)
			    IBSheet.create({ id: "sheet", el: "sheetDiv", options: gridOptList[0] });

			    //시트 생성 이후
			    IBSheet.onRenderFirstFinishAll = function(obj){
					fnSearch(); //조회 호출
				};

				//sheet 원클릭 처리
				sheet.bind("onAfterClick" , function(obj) { //원클릭
					if(obj.kind === "Filter") return;
					rowData = this.getFocusedRow(); //생성된 행 정보 가져오기

					if(obj.col === "btnView"){


					}else{
						for(var elem in rowData){
							$("#"+elem).val(rowData[elem]);
						}
						//버튼활성화
						fnBtnDis(false, false, true, true);
					}

				});

				//버튼 초기
				$("#saveFrm button").prop("disabled", true);
				$("#btnIns").attr("disabled", false);
				$("#btnSend").attr("disabled", false);
			});

			//현황 조회
			var fnSearch = function(){
				param = JSON.stringify($("#serchFrm").serializeObject());
				com.fnIbsSearch("/kakao/selectKakaoList.do", param); //param, sheetId 생략 가능
			};

			//신규버튼
			var fnIns = function(){
				$("#saveFrm")[0].reset();

				$("#saveFrm #workType").prop("disabled", false);
				$("#saveFrm #useYn").prop("disabled", false);
				$("#saveFrm #msgTitl").prop("disabled", false);
				$("#saveFrm #msgCont").prop("disabled", false);
				$("#saveFrm #refVal").prop("disabled", false);
				$("#saveFrm #remark").prop("disabled", false);
				$("#saveFrm #bizCd").prop("disabled", false);

				//버튼활성화
				fnBtnDis(true, true, false, false);

				$("#useYn").val("Y");
				$("#rptNo").val("");
				$("#msgSeq").val("");
			};

			//수정버튼
			var fnUpt = function(){

				//버튼활성화
				fnBtnDis(true, true, false, false);

			};

			//취소버튼
			var fnCan = function(){
				//선택 row 또는 키 값이 있을경우, 비활성화 후 정보 세팅
				$("#saveFrm")[0].reset();

				//버튼활성화
				fnBtnDis(false, true, true, true);

			 	$("#rptNo").val("");
			};

			//버튼 활성화처리
			var fnBtnDis = function(bolIns, bolUpt, bolCan, bolSave){

				$("#saveFrm #workType").prop("disabled", bolCan);
				$("#saveFrm #useYn").prop("disabled", bolCan);
				$("#saveFrm #msgTitl").prop("disabled", bolCan);
				$("#saveFrm #msgCont").prop("disabled", bolCan);
				$("#saveFrm #refVal").prop("disabled", bolCan);
				$("#saveFrm #remark").prop("disabled", bolCan);
				$("#saveFrm #bizCd").prop("disabled", bolCan);
				
			 	$("#btnIns").attr("disabled", bolIns);
			 	$("#btnUpt").attr("disabled", bolUpt);
			 	$("#btnCan").attr("disabled", bolCan);
			 	$("#btnSave").attr("disabled", bolSave);
			 	
			 	$("#saveFrm #param").prop("disabled", false);
			}


			//저장버튼
			var fnSave = function(){

				//필수체크
				var valChks = ["workType", "msgTitl", "bizCd", "msgCont"];

				if(com.fnValChk(valChks)){

					//신규, 수정 확인
					var newYn = $("#msgSeq").val();
					var msg = "저장";
					var url = "/kakao/insertKakao.do";

					if(newYn !== ""){
						msg = "수정";
						url = "/kakao/updateKakao.do";
					}

					if(confirm(msg + " 하시겠습니까?")){
						obj = {url:url, formId:"saveFrm", callBack:fnSaveCallBack, msgYn:"Y", sessYn:"Y", loadYn:"Y"};
						com.fnAjaxPost(obj);
					}
				}
			};

			//저장콜백
			var fnSaveCallBack = function(resData){

				console.log(resData);
				if(resData.resultCode === 0){
					$("#saveFrm")[0].reset();

					//버튼활성화
					fnBtnDis(false, true, true, true);

					fnSearch();
				}

			}

			//전송
			var fnSend = function(){
				rowData = sheet.getFocusedRow(); //생성된 행 정보 가져오기
				if(rowData === null){
					alert("전송할 메세지를 선택하십시오.");
					return;
				}
				
				let param = $("#param").val();
				if(param === ""){
					alert("전송 파라미터를 입력 하십시오\n예시) 입력값1,입력값2,입력값3");
					return;
				}
				
				//파라미터 개수 체크
				params = param.split(":");
				let refVal = rowData.refVal;
				refVals = refVal.split(":");
				
				if(params.length != refVals.length){
					alert("전달 파라미터 개수가 다릅니다.");
					return;
				}
				

				if(confirm("전송 처리 하시겠습니까?")){
					//param = {msgSeq:rowData.msgSeq, membNo:$("#membNo").val(), param:$("#param").val(), telNo:$("#telNo").val()}
					param = {msgSeq:rowData.msgSeq, param:$("#param").val(), telNo:$("#telNo").val(), telNm:$("#telNm").val(), refNo:""}
					obj = {url:"/kakao/sendKakao.do", param:param, callBack:fnSendCallBack, msgYn:"Y", sessYn:"Y", loadYn:"N"};
					com.fnAjaxDef(obj);
				}
			}

			//전송콜백
			var fnSendCallBack = function(){
				//alert("");
			}


			/*]]>*/
		</script>

		<!-- 콘텐츠 시작 -->
		<div class="contentsArea">
			<div class="contentsTop">
				<div th:insert="~{/fragments/subTitle}"></div>
				<div class="collapseCtrl">
					<button type="type" class="btn-collapse down"><span></span></button>
<!--					<button type="type" class="btn-collapse close"><span></span></button>-->
					<button type="type" class="reLoadFrm"></button>
				</div>
			</div><!-- //contentsTop -->

			<div class="contents flex">
				<!-- 검색 부분 -->
				<form name="serchFrm" id="serchFrm" method="post" onSubmit="return false">
				<section class="searchArea mt10">
					<div class="row">
						<dl>
							<dt>업무구분</dt>
							<dd style="width:140px;">
								<select name="sWorkCd" id="sWorkCd" style="width:140px;"></select>
							</dd>
						</dl>
						<dl>
							<dt>메세지명</dt>
							<dd style="width:180px;">
								<input type="search" name="sMsgTitl" id="sMsgTitl" style="width:200px;" maxlength="100"/>
							</dd>
						</dl>
					</div><!-- //row -->

					<div class="searchBtn">
						<button type="button" onclick="javascript:fnSearch();" class="btn search">조회</button>
					</div>
				</section>
				</form>
				<!-- 검색 부분 끝 -->

				<div class="layer-flex mt20 collapseArea">
					<!-- 내용 좌측 부분 -->
					<div class="collapseBox" style="width:65%">
						<div class="mt10">
					    	<div id="sheetDiv" style="width:100%;height:600px"></div>
						</div>
					</div>
					<!-- 내용 좌측 부분 끝 -->
					<!-- 내용 우측 부분 -->
					<div class="collapseBox fixable" style="width:33%">
						<form name="saveFrm" id="saveFrm" method="post" onSubmit="return false">
						<input type="hidden" name="msgSeq" id="msgSeq"  value=""/>
						<!-- 상단 부분 -->
						<section class="area">
							<div class="fr">
								<button id="btnSend" onclick="javascript:fnSend();" class="btn style07">전송</button>
								<button id="btnIns" onclick="javascript:fnIns();" class="btn style08">신규</button>
								<button id="btnUpt" onclick="javascript:fnUpt();" class="btn style08">수정</button>
								<button id="btnCan" onclick="javascript:fnCan();" class="btn style08">취소</button>
								<button id="btnSave" onclick="javascript:fnSave();" class="btn style07">저장</button>
							</div>
						</section>
						<!-- 상단 부분 끝 -->
						<table class="tbl mt10" >
							<colgroup>
								<col style="width:120px;">
								<col style="">
								<col style="width:100px;">
								<col style="">
							</colgroup>
							<tbody>
								<tr>
									<th>업무구분</th>
									<td colspan="3">
										<select name="workType" id="workType" style="width:140px;" title="업무구분" disabled></select>
									</td>
								</tr>
								<tr>
									<th>메세지명</th>
									<td colspan="3">
										<input type="search" name="msgTitl" id="msgTitl" title="메세지명" style="width:240px;" disabled maxlength="100">
									</td>
								</tr>
								<tr>
									<th>템플릿코드</th>
									<td colspan="3">
										<input type="search" name="bizCd" id="bizCd" title="템플릿코드" style="width:240px;" disabled maxlength="30">
									</td>
								</tr>
								<tr>
									<th>사용여부</th>
									<td colspan="3">
										<select name="useYn" id="useYn" style="width:100px;" title="사용여부" disabled></select>
									</td>
								</tr>
								<tr>
									<th>메세지내용</th>
									<td colspan="3">
										<textarea name="msgCont" id="msgCont" cols="60" rows="8" title="메세지내용" disabled maxlength="2000"></textarea>
									</td>
								</tr>
								<tr>
									<th>변수정보</th>
									<td colspan="3">
										<textarea name="refVal" id="refVal" cols="60" rows="2" title="변수정보" disabled maxlength="100"></textarea>
									</td>
								</tr>
								<tr>
									<th>설명</th>
									<td colspan="3">
										<textarea name="remark" id="remark" cols="60" rows="3" disabled maxlength="1000"></textarea>
									</td>
								</tr>
								<tr>
									<th>변수(테스트)</th>
									<td colspan="3">
										<input name="param" id="param" style="width:300px;"  maxlength="200">
									</td>
								</tr>
								<tr>
									<th>연락처(테스트)</th>
									<td>
										<input name="telNo" id="telNo" style="width:150px;"  maxlength="12">
									</td>
									<th>연락처명(테스트)</th>
									<td>
										<input name="telNm" id="telNm" style="width:150px;"  maxlength="12" value="테스트">
									</td>
								</tr>
								<tr>
									<th>조합원번호(테스트)</th>
									<td colspan="3">
										<input name="membNo" id="membNo" style="width:150px;"  maxlength="5">
									</td>
								</tr>
							</tbody>
						</table>
						</form>
					</div>
					<!-- 내용 우측 부분 끝 -->
					<!-- END 컨텐츠 영역 -->
				</div>
			</div><!-- //contents -->
		</div><!-- //contentsArea -->
		<iframe id="downfrm" style="display:none;" title="오즈설치용"></iframe> <!-- 오즈설치용 -->
	</body>
</html>