<!--
	파일정보: invt/invtDtl.html
	파일명 : invtDtl
	업무명 : 출자관리:출자정보수정
	생성자 : 윤가영1
	생성일 : 2023-04-13
-->
<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="/layout/subLayout">
	<body>
		<script th:inline="javascript">
			/*<![CDATA[*/
			var codeList = /*[[${codeList}]]*/; //공통코드
			var gridColList = /*[[${gridColList}]]*/; //그리드옵션
			var gridOptList = []; //그리드옵션
			//var initParam = {codeList : "IV02:IV06:IV08:IV03", gridNoList : "20110", accYn : "Y"}
			
			//초기화 조회 콜백
			$(document).ready(function(){
				//화면 처리
				$( "#dealAmt,#investNum,#investAmt" ).change(function(){
					invtCom.fnInitBill();  //출자증권발행정보 초기화
			    });
			    
				//코드값 처리
				com.fnCodeSelectBox("IV02", "payWay", 1, ""); //선택 입금형태
				com.fnCodeSelectBox("IV06", "procStat", 0, "40"); //전체 처리상태
				//com.fnCodeSelectBox("GR01", "guarStat3", 1, "12"); //선택에 값 설정
				
				//동적 첨부파일 생성(동적)
				com.fnFileSet("IV08", "myUpload"); 
				
				//출자 콘텐츠조합 입금계좌 목록 조회
				//invtCom.fnKocfcBankAcc("selBank",1);
				com.fnSetBankAccList("selBank", 1);	
				
				//줄자증권발행정보 설정
				invtCom.fnSetinvtStock("IV03", "billTypeTbl") 
				
				//동적 첨부파일 생성(동적)
				//com.fnFileSet("IV08", "myUpload"); 
					
			    fnSearch(); //조회 호출
			});
			
			//////////////////////////////////////// 출자정보 수정 시작 ////////
			
			//처리상태, 처리상태가 접수~처리중일땐 날짜와 처리자명 없음
			var fnProcStatChange = function() {
				if(Number($("#procStat").val()) <= 20) {
					$("#procDt").val("");
					$("#procNm").val("");
				} else {
					$("#procDt").val(/*[[${today}]]*/);
					$("#procNm").val(/*[[${session.userNm}]]*/);
				}
			}
			
			//검색
			var fnSearch = function(){
				//상세정보 조회
			    var membNo = /*[[${paramMap.membNo}]]*/;
			    var investNo = /*[[${paramMap.investNo}]]*/;
			    var atthType = /*[[${menuInfo.atthType}]]*/;
			    
			    var param = {membNo : membNo, investNo : investNo, atthType: atthType};
				obj = {url:"/invt/selectInvt.do", param:param, callBack:fnSearchCallBack, msgYn:"N", sessYn:"Y", loadYn:"Y"};
				com.fnAjaxDef(obj);
			};
			
			//검색콜백
			var fnSearchCallBack = function(resData){
				console.log(resData);
				com.fnSetKeyVal(resData.memb);
				com.fnSetKeyVal(resData.invtData);
				
				//payBank,payAcct - 입금은행 
				var bankOp = resData.invtData.payBank+','+resData.invtData.payAcct
				$("#selBank").val(bankOp);
				
				//출자발행정보 세팅 (등록된 좌권html 먼저 불러오고 , 가지고있는 좌권 세팅)
				var resBillList = resData.data;
				$.each(resBillList, function(idx, item){
					var type = item.billType;
					$("#dealAmt"+type).val(item.dealAmt === null ? "":com.aprojomma(item.dealAmt));	
					$("#billAmt"+type).val(item.billAmt === null ? "":item.billAmt);	
					$("#billCnt"+type).val(item.billCnt === null ? "":item.billCnt);	
					$("#remark"+type).val(item.remark === null ? "":item.remark);	
					
					invtCom.calcByBillNum(item.billType); //증권매수설정
					
				});
				
				//처리완료 40는 수정불가 처리 (임시 - 협의필요)
				if(resData.invtData.procStat === "40"){
					$("#saveFrm").find('input, select, button').prop("disabled", true);
					alert("처리상태가 처리완료(40) 출자정보는 수정불가");
				}
				
				//첨부파일 
				com.fnIbsUploadViewOne(resData.fileList, "upt");
				
				$.each($("div[id^='docSubmitDt']"), function(idx, item){
					var dtTxt = com.fnDateFormat($(item).val(),'-');
					$(item).val(dtTxt);
				});
				
				//시트값 설정
				//sheet.loadSearchData(resData.data);
				
				
				//홈페이지에서 추가출자후, 출자일자가 있을경우는 발행증권 초기세팅 진행
				$.each($("#billTypeTbl input[name^='dealAmt']"), function(idx, item){
					var val = $(item).val();
					if(val === "" || val === undefined) {
						if($("#investDt").val() !== "" || $("#investDt").val() !== undefined){
							invtCom.selectFaceDeal(); 
				 		}
				 		return false; 
					}
				});
				
				//메뉴탭 조합원명세팅
				let tabObj = {target: $("#ele_membNm").text()}
				com.fnSetTabMembTag(tabObj);
				
			};
			
			//저장
			var fnSave = function(){
				
				//필수체크
				var valChks = ["investDt","investNum","payWay","selBank"];
				if(com.fnValChk(valChks)){
					//출자좌수와 증권발행합계 체크
					if(com.rmComma($("#sumBillCnt").val()) !== com.rmComma($("#investNum").val())) {
			            alert("출자좌수와 증권발행정보의 합계가 일치하지 않습니다.");
			            return false;
			        }
			        
			        //파일여부
					var fileList = $("#docFile01").IBUpload('fileList');
					if(fileList.length === 0){
						alert("가입신청서 파일을 첨부하십시오.");
						return;
					}
					
					//첨부파일 첨부한 순서 코드따오기 (물리적저장순서 맞춰야해서 필수)
					com.fnGetModCds("docFile");
			        
					if(confirm("저장 처리 하시겠습니까?")){
						
						obj = {url:"/invt/updateInvt.do", formId:"saveFrm", fileId:"docFile", callBack:fnSaveCallBack, msgYn:"Y", sessYn:"Y", loadYn:"Y"};
						com.fnAjaxMulti(obj);
						
					}
					
				}	
			};
			
			//저장콜백
			var fnSaveCallBack = function(resData){
				
				//정상처리시 수정탭 닫기
				if(resData.resultCode === 0) {
					parent.closeMenu(/*[[${menuInfo.menuIdx}]]*/, /*[[${menuInfo.refMenuIdx}]]*/);
					//com.fnDoAfterClose(); 
				}
			};
			
		</script>
		
		<!-- 콘텐츠 시작 -->
		<div class="contentsArea">
			<div class="contentsTop">
				<div th:insert="~{/fragments/subTitle}"></div>
				
				<!--title 버튼 영역-->
				<div class="topBtnsWrap">
					<!--오른쪽접기화면 컨트롤 버튼-->
					<div class="collapseCtrl">
						<button type="type" class="btn-collapse down"><span></span></button>
						<button type="type" class="reLoadFrm"></button>
					</div>
					<!--오른쪽 업무 버튼-->
					<!--<div class="bizBtns">
						<button type="button" onclick="" class="btn style01">저장</button>
						<button type="button" onclick="" class="btn style02">저장</button>
						<button type="button" onclick="" class="btn style03">저장</button>
						<button type="button" onclick="" class="btn style04">저장</button>
						<button type="button" onclick="" class="btn style07">저장</button>
						<button type="button" onclick="" class="btn style08">저장</button>
					</div>-->
				</div>
				
			</div><!-- //contentsTop -->
			<form name="saveFrm" id="saveFrm" method="post" onSubmit="return false;" action="">
			<input type="hidden" name="atthType" id="atthType" th:value="${paramMap.atthType}"/>
			<input type="hidden" name="imgAtthNo" id="imgAtthNo" />
			<input type="hidden" name="atthNo" id="atthNo"/>
			<input type="hidden" name="investNo" id="investNo" th:value="${paramMap.investNo}"/>
			<input type="hidden" name="membNo" id="membNo" th:value="${paramMap.membNo}"/>
			<input type="hidden" name="modFileCds" id="modFileCds" />
			<div class="contents flex">
				<div class="layer-flex collapseArea">
					<!-- 그리드 좌측 부분 -->
					<div class="collapseBox" style="width:49%">
						<th:block th:include="com/comMemb"></th:block> <!--조합원조회 -->
						
						<!--출자정보 : s-->
						<div class="wrapBox">
							<section class="area mt5">
								<div class="fl">
									<h4 class="title">출자정보</h4>
								</div>
							</section>
							<table class="tbl">
								<colgroup>
									<col style="width:90px;">
									<col style="">
									<col style="width:100px;">
									<col style="">
									<col style="width:100px;">
									<col style="">
									<col style="width:150px;">
									<col style="">
								</colgroup>
								<tbody>
									<tr>
										<th>출자일자</th>
										<td colspan="3">
											<input type="search" name="investDt" id="investDt" title="출자일자" maxlength="10" onkeyup="com.fnOnlyNum(this);com.fnDateMakeForm(this); invtCom.selectFaceDeal();" onblur="com.fnDateValiChk(this)" style="width:110px"/>
											<img src="../images/icon_calendar.png" class="calendar-box" onclick="calendar(this, 'investDt', 'yyyy-mm-dd','','',invtCom.selectFaceDeal)" />
										</td>
										<th>출자구분</th>
										<td colspan="3"><div id="ele_investNm"><div></td>
									</tr>
									<tr>
										<th>좌당액면가</th>
										<td colspan="3">
                    						<input type="search" name="dealAmt" id="dealAmt" style="width:130px" title="좌당액면가" readonly />	
											<input type="hidden" name="faceAmt" id="faceAmt" />
										</td>
										<th>줄자좌수/금액</th>
										<td colspan="3">
											<input type="search" id="investNum" name="investNum" style="width:55px" maxlength="5" title="줄자좌수" onkeyup="com.fnOnlyNum(this);com.makeComma(this); invtCom.fnCalcByNum();"> 
											<span class="text">/</span>
											<input type="search" id="investAmt" name="investAmt" style="width:100px" title="금액" readonly>
										</td>
									</tr>
									<tr>
										<th>입금형태</th>
										<td colspan="3"><select name="payWay" id="payWay" title="입금형태" style="width:130px"></td>
										<th>입금자</th>
										<td colspan="3">
											<input name="payNm" id="payNm" type="search" style="width:100%" title="입금자" maxlength="20"/>
										</td>
									</tr>
									<tr>
										<th>입금은행</th>
										<td colspan="3">
											<select name="selBank" id="selBank" title="입금은행" style="width:130px" onchange="com.fnBankChange(this.value);">
												<optoin value=""></option>
											</select>
											<input type="hidden" name="payBank" id="payBank" />
										</td>
										<th>입금계좌</th>
										<td colspan="3">
											<input name="payAcct" type="search" id="payAcct" style="width:100%" title="입금계좌" readonly="readonly" />
										</td>
									</tr>
									<tr>
										<th>비고</th>
										<td colspan="7"><input type="search" name="remark" id="remark" style="width:100%" maxlength="50" title="비고" ></td>
									</tr>
								</tbody>
							</table>
						</div><!-- //wrapbox-->
						<!--출자정보 : e-->
						
						<!--처리정보 : s-->
						<div class="wrapBox">
							<section class="area mt5">
								<div class="fl">
									<h4 class="title">처리정보</h4>
								</div>
							</section>
							<table class="tbl">
								<colgroup>
									<col style="width:90px;">
									<col style="">
									<col style="width:100px;">
									<col style="">
									<col style="width:100px;">
									<col style="">
								</colgroup>
								<tbody>
									<tr>
										<th>처리상태</th>
										<td><select name="procStat" id="procStat" title="처리상태" style="width:120px" onchange="fnProcStatChange()"></select></td>
										<th>처리일자</th>
										<td>
											<input type="search" name="procDt" id="procDt" title="처리일자" onkeyup="com.fnOnlyNum(this);com.fnDateMakeForm(this)" onblur="com.fnDateValiChk(this)" style="width:100px" maxlength="10"/>
											<img src="../images/icon_calendar.png" class="calendar-box" onclick="calendar(this, 'procDt', 'yyyy-mm-dd')" />
										</td>
										<th>처리자</th>
										<td><input type="search" name="procNm" id="procNm" style="width:110px" title="처리자" readonly></td>
									</tr>
									<tr>
										<th>처리사유</th>
										<td colspan="5"><input type="search" name="procReason" id="procReason" style="width:100%" maxlength="50" title="비고" ></td>
									</tr>
								</tbody>
							</table>
						</div><!-- //wrapbox-->
						<!--처리정보 : e-->
						
						<!--수정사유 : s-->
						<section class="area mt5">
							<div class="fl">
								<h4 class="title">수정사유</h4>
							</div>
							<div>
								<textarea id="modReason" name="modReason" cols="10" rows="5"></textarea>
							</div>
						</section>
						<!--수정사유 : e-->
						
					</div>
					
					<!-- 그리드 우측 부분 시작 -->
					<div class="collapseBox fixable" style="width:49%">
						
						<!--출자증권발행정보 : s-->
						<div class="wrapBox">
							<section class="area">
								<div class="fl">
									<h4 class="title">출자증권발행정보</h4>
								</div>
								<div class="fr">
									<button type="button" onclick="javascript:invtCom.fnAutoBill();" class="btn small style08">권종자동설정</button>
								</div>
							</section>
							<table id="billTypeTbl" class="tbl">
								<colgroup>
									<col style="width:100px;">
									<col style="">
									<col style="width:100px;">
									<col style="">
									<col style="width:100px;">
									<col style="">
								</colgroup>
								<thead>
									<tr>
										<th scope="col" class="alignC">권종</th>
										<th scope="col" class="alignC">액면가</th>
										<th scope="col" class="alignC">매수</th>
										<th scope="col" class="alignC">금액</th>
										<th scope="col" class="alignC">비고</th>
									</tr>
								</thead>
								<tbody>
									<tr>
										<th scope="row" class="alignC">1좌권</th>
										<td class="alignC"><input type="search" name="" style="width:100%" title="1좌권" readonly></td>
										<td class="alignC"><input type="search" name="" style="width:100%" maxlength="5" title="매수"></td>
										<td class="alignC"><input type="search" name="" style="width:100%" title="금액" readonly></td>
										<td colspan="2" class="alignC"></td>
									</tr>
									<tr>
										<th scope="row" class="alignC">5좌권</th>
										<td class="alignC"><input type="search" name="" style="width:100%" title="5좌권" readonly></td>
										<td class="alignC"><input type="search" name="" style="width:100%" maxlength="5" title="매수"></td>
										<td class="alignC"><input type="search" name="" style="width:100%" title="금액" readonly></td>
										<td colspan="2" class="alignC"></td>
									</tr>
									<tr>
										<th scope="row" class="alignC">10좌권</th>
										<td class="alignC"><input type="search" name="" style="width:100%" title="10좌권" readonly></td>
										<td class="alignC"><input type="search" name="" style="width:100%" maxlength="5" title="매수"></td>
										<td class="alignC"><input type="search" name="" style="width:100%x" title="금액" readonly></td>
										<td colspan="2" class="alignC"></td>
									</tr>
									<tr>
										<th scope="row" class="alignC">20좌권</th>
										<td class="alignC"><input type="search" name="" style="width:100%" title="20좌권" readonly></td>
										<td class="alignC"><input type="search" name="" style="width:100%" maxlength="5" title="매수"></td>
										<td class="alignC"><input type="search" name="" style="width:100%" title="금액" readonly></td>
										<td colspan="2" class="alignC"></td>
									</tr>
									<tr>
										<th scope="row" class="alignC">50좌권</th>
										<td class="alignC"><input type="search" name="" style="width:100%x" title="50좌권" readonly></td>
										<td class="alignC"><input type="search" name="" style="width:100%" maxlength="5" title="매수"></td>
										<td class="alignC"><input type="search" name="" style="width:100%" title="금액" readonly></td>
										<td colspan="2" class="alignC"></td>
									</tr>
									<tr>
										<th scope="row" class="alignC">100좌권</th>
										<td class="alignC"><input type="search" name="" style="width:100%" title="100좌권" readonly></td>
										<td class="alignC"><input type="search" name="" style="width:100%" maxlength="5" title="매수"></td>
										<td class="alignC"><input type="search" name="" style="width:100%" title="금액" readonly></td>
										<td colspan="2" class="alignC"></td>
									</tr>
								</tbody>
								<tfoot>
									<tr>
										<th class="alignC" scope="colgroup" colspan="2">합계</th>
										<td class="alignC"><input type="search" name="" style="width:100%" title="" readonly></td>
										<td class="alignC"><input type="search" name="" style="width:100%" title="" readonly></td>
										<td colspan="2" ></td>
									</tr>
								</tfoot>
							</table>
						</div><!-- //wrapbox-->
						<!--출자증권발행정보 : e-->
						
						<!--심사서류정보 : s-->
						<div class="wrapBox">
							<section class="area mt15">
								<div class="fl">
									<h4 class="title">심사서류정보<span style="font-size: 11px; color: #ff6600">(첨부할 파일을 끌어다 놓으시거나, 마우스 오른쪽버튼 -> '추가'로 첨부바랍니다.)</span></h4>
								</div>
							</section>
							<table class="tbl" id="myUpload"></table>
						</div>
						<!--심사서류정보 : e-->	
						
					</div>
					<!-- END 컨텐츠 영역 -->
				</div>
				<div class="layer-flex mt50">
					<!-- 처리 버튼 영역 -->
					<div class="" style="width:100%">	
						<section class="area">
							<div class="fc">
								<button type="button" onclick="javascript:fnSave();" class="btn style07">수정</button>
							</div>
						</section>
					</div>
					<!-- 처리 버튼 영역 끝-->
						
				</div>
			</div><!-- //contents -->
			</form>
		</div><!-- //contentsArea -->
	</body>
</html>
