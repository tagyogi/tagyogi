<!--
	파일정보 : guar/guarDtl.html
	파일명 : guarDtl
	업무명 : 보증상세 정보
	생성자 : 변성균
	생성일 : 2023-04-10

	<th:block th:include="com/comMemb"></th:block> 조합원조회
	<th:block th:include="guar/comGuarDtl"></th:block> 보증상세정보
	<th:block th:include="guar/comGuarContrDtl"></th:block> 보증약정정보
	<th:block th:include="guar/comGuarPay"></th:block> 보증납부정보

	발급완료된 보증상세정보
	현황에 따라 버튼 제어
	전결현황 - 권한(본부자, 이사)에 따라 전결버튼만 허용



-->
<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="/layout/subLayout">
	<body>
		<th:block th:layout="comjs">
			<script th:src="@{/js/guarCom.js}"></script>
		</th:block>
		<script th:inline="javascript">
			/*<![CDATA[*/
			var codeList = /*[[${codeList}]]*/; //공통코드
			var gridColList = /*[[${gridColList}]]*/; //그리드옵션
			var gridOptList = []; //그리드옵션
			//var initParam = {codeList : "GR22:GR23", gridNoList : "", accYn : "Y"}

			var accList = []; //조합계좌정보
			var guarType = ""; //보증유형 전역설정
			var paramMap = /*[[${paramMap}]]*/;
			//var guarInfo = "";	--> comGuarPay.html로 위치 변경(수정페이지에도 호출부가 있어서 오류)
			var membAccList = ""; //조합원계좌

			//초기화 조회 콜백
			$(document).ready(function(){
				$("#areaGuarContr_hideBtn").removeClass('hide');	//comGuarContrDtl.html 숨김버튼 보이기

				//동적 첨부파일 (다건)
				com.fnIbsUpload($("#docFile"));

				//IBsheet 초기화
				com.fnIbsInit(/*[[${menuInfo.workGrid}]]*/);

				gridOptList[4].Cfg.CanEdit = 1; //미수납부이력현황

				//그리드 옵션추가 (납입목록)
				$.each(gridOptList[4].Cols, function(idx, item){
					let name =  item.Name;

					if(name === "SEQ" || name === "payAcct" ) return;
					if(name === "delChk"){
						item.Visible = 1;
					}else{
						item.CanEdit = 1;	//수정가능하게
					}

					//입출금계좌 (조합원계좌)
					var getEnum = com.fnBankIbSelectBox();
					if(name === "payBankVal"){
						item.Enum = getEnum.enumNm;
						item.EnumKeys = getEnum.enumKeys;
						item.OnChange = fnCtrlbankAcct;//계좌세팅
					}

				});

				//초기 데이터 설정 (id : 시트 객체 ID, el : 시트를 생성할 DIV객체 ID, options : 초기화 구문 변수, data : DATA)
				IBSheet.create({ id: "sheetGuar", el: "sheetGuarDiv", options: gridOptList[0] }); //30315 보증변경현황
			    IBSheet.create({ id: "sheet", el: "sheetDiv", options: gridOptList[1] }); // 30316 전자보증이력
			    IBSheet.create({ id: "sheetGuarHist", el: "sheetGuarHistDiv", options: gridOptList[2] });	//30317 보증변경이력 gr_master_hist 테이블 컬럼이 많아서 필요한것만 그리드옵션에 넣음(그리드 옵션에 모든 컬럼 넣어두고 숨기면 속도에 영향)
			    IBSheet.create({ id: "sheetPart", el: "sheetPartDiv", options: gridOptList[3] }); //30318 일부해제현황
			    IBSheet.create({ id: "sheetGuarPayHist", el: "sheetGuarPayHistDiv", options: gridOptList[4] }); //30319 미수보증료납입이력

			    //sheet 더블클릭 처리(전자보증이력)
				sheet.bind("onDblClick" , function(obj) { //더블클릭
					if(obj.kind === "Filter") return;
					guarCom.fnG2bHisView(sheet);
				});

				//시트 생성 이후
			    IBSheet.onRenderFirstFinishAll = function(obj){
					fnSearchDtl(); //상세 조회
				};
			});


			//상세 조회
			var fnSearchDtl = function(){
				obj = {url:"/guar/selectGuar.do", formId:"serchFrm", callBack:fnDtlCallBack, msgYn:"N", sessYn:"Y", loadYn:"Y"};
				com.fnAjaxPost(obj);
			}

			//상세 조회 콜백
			var fnDtlCallBack = function(resData){
				//console.log(resData);
				guarInfo = resData.guar; //보증정보
				membAccList = resData.membAccList; //조합원계좌정보
				
				//알림톡세팅
				var setParam = {membNo: $("#membNo").val(), setTalk:"Y", setVal:resData.guar.talkNm}
				com.fnSetPersList(setParam);

				//2-1. 보증정보 + 주계약정보(화면)
				guarType = resData.guar.guarType;
				fnGuarContrViewSet(guarType, resData); //주계약정보 화면설정(상세) guar/comGuarDtl

				//2-2. 보증정보 + 주계약정보 + 발급정보 + 심사정보 + 보증료 미수처리(데이터)
				if(resData.guar.payYn === "Y" && resData.guar.afterPayYn === "N"){
					resData.guar.payAmtSum = resData.guar.commAmt //미수건이아니고 완납이 된경우 납입금액은 보증료금액과 같음
				}
				resData.guar.remainCommAmt = com.aprojomma(resData.guar.remainCommAmt);
				com.fnSetKeyVal(resData.guar);

				//조합원정보
				com.fnSetKeyVal(resData.memb);

				var summaryText = "";
				if(resData.guar.guarReqCd == "2"){	//변경등록일때
					var befSummary = com.fnNvlChk(resData.guar.befSummary,'');
					var summary = com.fnNvlChk(resData.guar.summary,'');
					summaryText += `[${resData.guar.initReqDt}]\n ${befSummary}`;
					summaryText += `\n[${resData.guar.reqDt}]\n ${summary}`;
				}else{
					summaryText = resData.guar.summary;
				}
				$("#ele_summary").text(summaryText);

				/*
				if(resData.guar.guarStat !== '10') {
					$("#area_guarCan").show();	//해제일자,해제사유 보이기
					if(com.fnIsEmpty(resData.guar.guarCanDt))	$("#ele_guarCanDt").text("(예정:"+resData.guar.canPreDt+")");
				}
				*/

				//2-3. 반려 사유 resData.g2bHisList.length !== 0 &&
				if(resData.guar.procStat === '41'){
					$("#resMsgArea").show();
				}

				//3-1. 약정정보
				//console.log(resData.contr);
				com.fnSetKeyVal(resData.contr, "areaGuarContr");

				//3-2. 약정정보(상품별 한도정보)
				var typeValue = guarType;
				if(guarType === "31")	typeValue = "13";
				if(guarType === "32")	typeValue = "12";
				if(guarType === "33" || guarType === "34")	typeValue = "15";
				$("#ele_limitAmt").text(com.aprojomma(resData.contr["limitAmt"+typeValue]));	//한도금액
				$("#ele_useAmt").text(com.aprojomma(resData.contr["useAmt"+typeValue]));		//사용액
				$("#ele_remainAmt").text(com.aprojomma(resData.contr["remainAmt"+typeValue]));	//가능액

				//4. 보증상품정보 목록(한도금액)
				guarCom.fnSetGuarLimitView("GR22", "tbl_guarLimit", resData.contr);

				//5. 심사전결관련(화면)
				//console.log("decType: " + resData.guar.decType);
				if(resData.guar.decType === 'A')	{
					$("#ele_decDirInfo").show();	//확인
					$("#ele_decMngInfo").show();	//전결
				}else if(resData.guar.decType === 'Y') {
					$("#ele_decDirInfo").show();	//전결
				}

				//7. 첨부파일
				com.fnIbsUploadView($("#docFile"), resData.fileList);

				//납입정보 표출 (comGuarPay.html)
				if(resData.guar.payYn == "Y"){
					$("#ele_guarPayArea").show(); //납입정보
					com.fnSetKeyVal(resData.guar, "ele_guarPayArea");
				}

				//환불 (환불정보 있을 경우 )
				if(resData.guar.retCommAmt !== "0" && resData.guar.retCommAmt !== ""){
					$("#ele_guarRetArea").show(); //납입정보
					com.fnSetKeyVal(resData.guar, "ele_guarRetArea");
				}

				//8-1. 버튼 관련
				////////////////////////////////////////////////////////////////////////////////////////// 버튼처리 시작
				var listType = paramMap.listType;
				var procStat = guarCom.fnToNumber(resData.guar.procStat);
				var retCommAmt = resData.guar.retCommAmt;
				var payYn    = resData.guar.payYn;
				var docNo = resData.guar.docNo;
				var guarIssueCd = resData.guar.guarIssueCd;
				var commAmt = resData.guar.commAmt;	//보증료 미수처리 영역 보증료
				var afterPayYn =  resData.guar.afterPayYn;
				var userNm 	 = /*[[${session.userNm}]]*/;

				//전결현황 에서 넘어왔을 경우 (발급이후 금액에 따른 전결 처리로 발급정보만 필요)
				if(listType === "VIEW" ){ //전결현황, 해제현황, 만기도래 현황, 실적현황
					//console.log(resData.guar.decDirNm);
					//console.log(resData.guar.decDirDt);
					var userNm = /*[[${session.userNm}]]*/;
					if(resData.guar.decDirNm === userNm){
						if(resData.guar.decDirDt === null) {	//전결처리 버튼
							$("#decProc").val("dir");
							$("#decBtn").show();
						}
					}

					if(resData.guar.decMngNm === userNm){
						if(resData.guar.decMngDt === null) {	//전결처리 버튼
							$("#decProc").val("mng");
							$("#decBtn").show();
						}
					}

					//보증변경이력 2024-02-20 배서현 요청으로 추가 cjh
					if(resData.guarHistList !== undefined){
						$("#area_guarHist").css("display", "");
						sheetGuarHist.loadSearchData(resData.guarHistList);
					}

					//메뉴탭 조합원명세팅
					let tabObj = {target: $("#ele_membNm").text()}
					com.fnSetTabMembTag(tabObj);

					////////////////////////////////////레포트버튼 시작

					//보증료 버튼
					if(procStat >= 40)							$("#rpGuarBtn").show();

					//영수증버튼 입찰,하자,채무
					if(guarType === "11" || guarType === "13" || guarType === "21"){
						if(payYn === 'Y' || payYn === 'H') {
							$("#rpRcptBtn").show();		//영수증 버튼
						}
					}else if(procStat >= 40 && (payYn === 'Y' || payYn === 'H')) {
						$("#rpRcptBtn").show();		//영수증 버튼
					}



				//발급현황, 보증료현황, 미수수료현황
				}else{ //PROC


					//console.log(procStat + " / " + payYn + " / " + guarStat);

					if(procStat === 30 || payYn === "H" || payYn === "R"){
						showGuarPayArea("mod");	//(comGuarPay.html)

						$("#commAmt").val(resData.guar.commAmt);

						//미수처리건 현재 부분납인경우 selectbox 세팅
						if(commAmt > resData.guar.payAmtSum) $("#payPartType").val('P');

					}

					//6-2. 보증료 미수처리 영역 보증료 값(보증정보 보증료에만 들어가서 따로 세팅)
					$("#ele_guarPayArea").find("#ele_commAmt").text(commAmt);

					//6-3. 납입금액 설정
					if(com.fnIsEmpty(resData.guar.payCommAmt))		$("#payCommAmt").val(commAmt);

					//6-4. 입금은행 선택 처리
					if(!com.fnIsEmpty(resData.guar.payBank) && !com.fnIsEmpty(resData.guar.payAcct)) {	//입금은행
						$("#selBank").val(resData.guar.payBank + "," + resData.guar.payAcct);
					}


					//심사 승인 확인 버튼
					if(procStat === 22)							$("#examBtn").show();

					//최초납입처리 버튼
					if(procStat === 30 || (payYn === "H" && procStat < 40)){
						$("#payBtn, #payYn").show();
					}else{
						$("#payBtn").hide();
					}

					//납입이 이미 이루어진 보증건을 미수처리 (이미 미수였던건 제외)
					if(payYn !== "H" && procStat >= 40 && afterPayYn !== "Y"){
						$("#setPayPartBtn").show();


					}

					//납부, 부분납 처리 (미수이면서 이미 최초납입(혹은미수) 처리가 되었던건들)
					if((payYn === "H" || payYn === "R") && afterPayYn === "Y" && procStat >= 40){
						$("#payPartType").show();
						$("#btn_partPayProc").show();
						$("#ele_guarNoPayArea").show();
						$("#ele_guarNoPayAreaGrid").show();

					}
					if(afterPayYn === "Y" && procStat >= 40){
						//미수 부분납 이력 그리드 표출 (완납되었어도 미수였던건은 이력확인 가능해야함)
						$("#ele_guarNoPayAreaGrid").show();
					}

					//재전송 버튼(2024.03.18) -- 전결현황에서 제거요청(VIEW 처리에서 재전송업무 없어도 될듯하여 변경)
					if(procStat >= 40 && guarIssueCd === "G") 	$("#electSendBtn").show();
					//-------------------------------------------------------------------------------------------
				}

				////////////////////////////////////레포트버튼 시작
				//보증료 버튼
				if(procStat >= 40)							$("#rpGuarBtn").show();

				//영수증버튼 입찰,하자,채무
				if(guarType === "11" || guarType === "13" || guarType === "21"){
					if(payYn === 'Y' || payYn === 'H') {
						$("#rpRcptBtn").show();		//영수증 버튼
					}
				}else if(procStat >= 40 && (payYn === 'Y' || payYn === 'H')) {
					$("#rpRcptBtn").show();		//영수증 버튼
				}

				//보증성환불양식 버튼
				if(Number(com.rmComma(commAmt)) < 0 ){
					$("#rpRetBtn").show();	//docNo가 없으면 안보임
				}

				if(Number(com.rmComma(retCommAmt)) > 0 ){
					$("#rpRetCanBtn").show();	//docNo가 없으면 안보임
				}

				////////////////////////////////////레포트버튼 끝

				//8-3. 관리자면 모든 버튼 보여지기
				if(/*[[${session.userId}]]*/ === "admin"){
					$("#btnArea").find('button').each(function(){
						if($(this).css("display") === "none"){
							var btnNm = $(this).text();
							//$(this).text(btnNm + "(admin)");
							//$(this).show();
						}
					});
				}

				//////////////////////////////////////////////////////////////////////////////버튼처리 끝

				//9. 전자보증 이력
				if(resData.g2bHisList !== undefined){
					$("#area_g2bHist").css("display", "");
					sheet.loadSearchData(resData.g2bHisList);
				}
				//10. 보증변경이력
				if(resData.guarHistList !== undefined){
					$("#area_guarHist").css("display", "");
					sheetGuarHist.loadSearchData(resData.guarHistList);
				}

				//12 부분납부이력 세팅
				if(resData.guarPartPayList !== undefined){
					sheetGuarPayHist.loadSearchData(resData.guarPartPayList);
				}
				//interSumRow = sheetInter.getRowById("FormulaRow");

				//보증해제일경우
				if(resData.guar.guarStat === '30' || resData.guar.guarStat === '31') {
					$("#area_canInfo").show();
				}
				//일부해제현황
				if(resData.partList !== undefined){
					$("#area_canPart").show();
					sheetPart.loadSearchData(resData.partList);
				}

				//적요, 특이사항, 비고 textArea 높이 적용 함수
				adjustHeight();

				//메뉴탭 조합원명세팅
				let tabObj = {target: $("#ele_membNm").text()}
				com.fnSetTabMembTag(tabObj);

				//조달청 정보 체크
				//console.log(guarInfo.guarIssueCd);
				if(guarInfo.guarIssueCd === "G"){
					console.log(resData.elect);
					if(resData.elect == undefined || resData.elect == null){
						//console.log("조달청재조회");
						//if(confirm("조회된 전자정보가 없습니다. 조회 진행 하시겠습니까?")){
							guarCom.fnG2bSearchDirect();
						//}
					}
				}
			}

			//레포트
			var fnReport = function(type){
				var membNo = $("#membNo").val();
				var guarNo = $("#guarNo").val();
				var pubDt = $("#guarPubDt").val();
				if(type === "GUAR"){ //증권
					ozGuar(guarType, guarNo, pubDt, membNo);

				}else if(type === "RCPT"){ //영수증
					var nameArr =  ["guar_no"];
					var valArr = [guarNo];
					ozLoad("GR_영수증_(공제계약자_보관용)", nameArr, valArr, 1, false, false, "doAfter");

				}else if(type === "MSUBS"){ //조합원청약서
					ozGuarSubs("10", guarType, guarNo);

				}else if(type === "SUBS"){ //청약서
					ozGuarSubs("", guarType, guarNo);
				}else if(type === "RET"){	//보증료환불양식
					var nameArr = ["guar_no", "ret_type"];
				    var valueArr = [guarNo, "P" ];
				    ozLoad("GR_보증료환불양식", nameArr, valueArr, 1, false, false, "");
				}else if(type === "RETCAN"){	//보증료환불양식
					var nameArr = ["guar_no", "ret_type"];
				    var valueArr = [guarNo, "R" ];
				    ozLoad("GR_보증료환불양식", nameArr, valueArr, 1, false, false, "");
				}
			}

			//심사 승인 확인 버튼 이벤트
			var fnGuarExamConfirm = function(){
				//console.log(/*[[${session}]]*/);
				var userNm = /*[[${session.userNm}]]*/;
				var userId = /*[[${session.userId}]]*/;

				if(com.fnIsEmpty($("#ele_examNm").text())){
					if(!com.fnIsEmpty($("#ele_guarApprNm").text()) && $("#ele_guarApprNm").text() === userNm ){
						alert('심사자와 심사승인자가 다를경우만 심사승인이 가능합니다.');
						return;
					}
				}

				if($("#ele_examNm").text() !== userNm){
					alert('심사승인자 대상이 아닙니다.');
					if(userId !== "admin")	return;
				}

			    if(!confirm("이 보증서의 심사를 승인하시겠습니까?")) return;

				$("#talkProcStat").val('30'); //알림톡발송여부를 위해 세팅

				var param = {guarNo : $("#guarNo").val()};
				obj = {url:"/guar/updateGuarConfirm.do", param:param, callBack:fnBeforeReLoad, msgYn:"Y", sessYn:"Y", loadYn:"Y"};
				com.fnAjaxDef(obj);
			}

			//납입/미수처리(최초) 버튼 이벤트
			var fnGuarPayProc = function(){

				var remainCommAmt = Number(com.rmComma($("#remainCommAmt").val())); //보증료
				var payAmt  = Number(com.rmComma($("#payAmt").val())); //납입입력값
				var commAmt  = Number(com.rmComma($("#commAmt").val())); //수수료

				if(remainCommAmt === payAmt){ //완납일경우
					$("#payYn").val('Y');
					alert('납입금액과 잔액이 같아 납부(Y)처리 됩니다.');
				}else{ //부분납인경우
					$("#payYn").val('H');
					alert('납입금액과 잔액이 같지않아 미수(혹은 부분납)처리 됩니다.');
				}

				//필수값
				if($("#payYn").val() === "") {
			        alert("입금상태를 선택해 주십시오.");
			        $("#payYn").focus();
			        return false;
			    }

				if(commAmt !== 0){
					/**미수*///
				    if($("#payYn").val() === "H") {
				        /*
				        if($("#payPreDt").val() === "") {
				            alert("청구일자를 입력해 주십시오.");
				            $("#payPreDt").focus();
				            return false;
				        }
						*/
				        //미수(최초납입)인데 부분납일경우(입금정보가 있을경우)
				        if(payAmt > 0){
							if($("#payDt").val() === "") {
					            alert("입금일자를 입력해 주십시오.");
					            $("#payDt").focus();
					            return false;
					        }

					        if($("#payWay").val() === "") {
					            alert("입금방법을 선택해 주십시오.");
					            $("#payWay").focus();
					            return false;
					        }

					        if($("#payBank").val() === "") {
					            alert("입금은행을 선택해 주십시오.");
					            $("#payBank").focus();
					            return false;
					        }
						}
				    }
					/**완납*///
				    if($("#payYn").val() === "Y") {
				        if($("#payDt").val() === "") {
				            alert("입금일자를 입력해 주십시오.");
				            $("#payDt").focus();
				            return false;
				        }

				        if($("#payWay").val() === "") {
				            alert("입금방법을 선택해 주십시오.");
				            $("#payWay").focus();
				            return false;
				        }
				    }
				}

			    var msg = "납입";
			    if($("#payYn").val() === "H"){
					msg = "미수";
					//$("#payAmt").val(''); //최초미수처리여도 입력한 납입금액은 미수 부분납 처리
				}

			    if(!confirm("이 보증서를 " + msg + "처리 하시겠습니까?")) return;
				$("#payProcType").val("P");
				obj = {url:"/guar/updateGuarPayToDocNo.do", formId:"serchFrm", callBack:fnReLoad, msgYn:"Y", sessYn:"Y", loadYn:"Y"};
				com.fnAjaxPost(obj);
			}

			//환불처리 버튼 이벤트
			var fnGuarRepayProc = function(){
				//필수값
				if($("#retDt").val() === "") {
		            alert("환불일자를 입력해 주십시오.");
		            $("#retDt").focus();
		            return false;
		        }

		        if($("#retWay").val() === "") {
		            alert("환불방법을 선택해 주십시오.");
		            $("#retWay").focus();
		            return false;
		        }

				if($("#retYn").val() === "") {
			        alert("환불상태를 선택해 주십시오.");
			        $("#retYn").focus();
			        return false;
			    }

			    if($("#retBanks").val() === "") {
			        alert("환불정보를 선택해 주십시오.");
			        $("#retBanks").focus();
			        return false;
			    }


			    if(!confirm("환불 및 발급처리를 하시겠습니까?")) return;
				$("#payProcType").val("R");
				obj = {url:"/guar/updateGuarPayToDocNo.do", formId:"serchFrm", callBack:fnReLoad, msgYn:"Y", sessYn:"Y", loadYn:"Y"};
				com.fnAjaxPost(obj);
			}




			//납입처리 버튼 이벤트
			var fnGuarPartPayProc = function(){

				//필수값
				if($("#payAmt").val() === "") {
			        alert("납입할 금액을 입력해 주십시오.");
			        $("#payAmt").focus();
			        return false;
			    }

				if($("#payPartType").val() === "") {
			        alert("입금상태를 선택해 주십시오.");
			        $("#payPartType").focus();
			        return false;
			    }

				/*
		        if($("#payPreDt").val() === "") {
		            alert("청구일자를 입력해 주십시오.");
		            $("#payPreDt").focus();
		            return false;
		        }
				*/
		        if($("#payDt").val() === "") {
		            alert("입금일자를 입력해 주십시오.");
		            $("#payDt").focus();
		            return false;
		        }

		        if($("#payWay").val() === "") {
		            alert("입금방법을 선택해 주십시오.");
		            $("#payWay").focus();
		            return false;
		        }

			    var msg = "완납";
			    if($("#payPartType").val() === "P"){
					msg = "부분납";
				}

				var restVal = Number(com.rmComma($("#remainCommAmt").val()));
				var payAmtVal = Number(com.rmComma($("#payAmt").val()));

				if(restVal < payAmtVal){
					alert("납부할 금액이 잔액보다 큽니다. 다시한번 확인해주세요.");
					$("#payAmt").focus()
					return;
				}

			    if(!confirm("보증료 " + msg + "처리 하시겠습니까?")) return;

				obj = {url:"/guarPay/insertGuarPartPayProc.do", formId:"serchFrm", callBack:fnReLoad, msgYn:"Y", sessYn:"Y", loadYn:"Y"};
				com.fnAjaxPost(obj);

			}

			//미수처리 버튼 이벤트
			var fnGuarPartNoPayProc = function(){
			    if(!confirm("이 보증서를 미수처리 하시겠습니까?")) return;
				obj = {url:"/guarPay/updateGuarPartNoPayProc.do", formId:"serchFrm", callBack:fnReLoad, msgYn:"Y", sessYn:"Y", loadYn:"Y"};
				com.fnAjaxPost(obj);
			}


			//전결처리
			var fnGuarDec = function(){
				var decProc = $("#decProc").val();	//dir or mng

				if(decProc === "mng" && $("#ele_decDirDt").text() === ""){
					alert("보증 미확인 처리 건 입니다.");
					return;
				}
			    if(!confirm("해당 보증서 검토 완료 처리 하시겠습니까?")) return;

				var param = { guarNo: $("#guarNo").val(), decProc: decProc };
				obj = {url:"/guar/updateGuarDec.do", param:param, callBack:fnReLoad, msgYn:"Y", sessYn:"Y", loadYn:"Y"};
				com.fnAjaxDef(obj);
			}

			//g2b전송(재발송 버튼)
			var fnG2bSend = function(){
				param = {guarNo: $("#guarNo").val()};

				if(!confirm("정말로 선택하신 " + com.fnInputText("GR01", guarType) + "보증서를 전송하시겠습니까?")) return;
				//if(!confirm(rowData.membNm+"["+com.fnInputText("GR01", guarType) + ":"+ rowData.servNm + "]\n보증서를 전송처리 하시겠습니까?")) return;
				obj = {url:"/guarElect/sendGuarElect.do", param:param, callBack:fnReLoad, msgYn:"Y", sessYn:"Y", loadYn:"Y"};
				com.fnAjaxDef(obj);
			}

			//수정
			var fnUpt = function(){

				//이동할 수정페이지 판단 변수
				var procStat = Number($("#procStat").val());	//처리상태
				var guarReqCd = $("#guarReqCd").val();
				var guarType = $("#guarType").val();
				var guarNo = $("#guarNo").val();

				//수정은 심사완료전까지만 가능하도록 반영
				if(procStat >= 30){
					//alert("심사완료 이전까지만 수정이 가능합니다.");
					//문구 수정 처리
					com.dialpopupOpen("보증정보수정", "/index/pageCall.do?menuCd=1070731&guarNo="+guarNo+"&refVal="+guarType+"&guarReqCd="+guarReqCd, "1400", "800");	// guar/guarUptPop

					return;
				}

				//이동할 수정페이지
				if(guarReqCd == "1")		paramMenuCd = "1030216";	//신청수정 (guar/guarReqUpt.html)
				else if(guarReqCd == "3")	paramMenuCd = "1030221";	//기재변경수정 (guar/guarChgDescUpt.html)
				else						paramMenuCd = "1030218"; 	//변경수정 (guar/guarChgUpt.html)

				param = {menuCd:paramMenuCd, paramMap:{guarNo: guarNo
													 , refVal: guarType }};//상품별 주계약화면 변경

				parent.menuOpen(param);
				parent.closeMenu(/*[[${menuInfo.menuIdx}]]*/);
			};

			//새로고침
			var fnReLoad = function(){
				$(".reLoadFrm").click();
			}

			//심사승인확인(심사완료) 후 카카오톡 발송 먼저하고 리로드
			var fnBeforeReLoad = function(resData){
				if(resData.resultCode === 0){
					/*심사완료*/
					if($("#talkProcStat").val() === "30"){
						//저장성공시 알림톡발송
						/*
						param1조합원의 보증신청이 심사완료되었습니다.
						납입하실 보증료는 param2원입니다.
						*/
						var paramsArray = [
						  $("#ele_membNm").text(),  //조합원명
						  $("#ele_commAmt").text(),     //보증료
						];

						// 배열을 콜론으로 구분된 문자열로 합치기
						var paramVal = paramsArray.join(':');
						param = {msgSeq:"11", membNo:$("#membNo").val(), param:paramVal, telNo:$("#talkTel").val(), telNm:$("#talkNm").val(), msgYn: "N"}
						com.fnSendTalkMsg(param);
					}
				}

				$(".reLoadFrm").click();
			}

			//oz 출력 이후
			var doAfter = function(){
				//oz.js에서 호출중
				//var param = { guarNo: $("#guarNo").val() };
				//obj = {url:"/guar/updateGuarPrintAfter.do", param:param, callBack:fnReLoad, msgYn:"Y", sessYn:"Y", loadYn:"Y"};
				//com.fnAjaxDef(obj);

				fnReLoad();
			}

			//입출금은행,계좌 (조합원계좌) sheetInPay
			var fnCtrlbankAcct = function(evtParam){
				var rowId = evtParam.row.id;
				//var rowIdx = evtParam.sheet.getRowIndex(rowId);
				var payBank = sheetGuarPayHist.getValue(sheetGuarPayHist.getRowById(rowId), "payBankVal");
				var bankCd  = payBank.split(",")[0];
				var bankNm  = payBank.split(",")[1];

				sheetGuarPayHist.setValue(sheetGuarPayHist.getRowById(rowId), "payBank", bankCd);
				sheetGuarPayHist.setValue(sheetGuarPayHist.getRowById(rowId), "payAcct", bankNm);

			}

			/*]]>*/
		</script>

		<!-- 콘텐츠 시작 -->
		<div class="contentsArea">
			<div class="contentsTop">
				<div th:insert="~{/fragments/subTitle}"></div>

				<div class="topBtnsWrap">
					<!--오른쪽접기화면 컨트롤 버튼-->
					<div class="collapseCtrl">
						<button type="type" class="btn-collapse down active"><span></span></button>
<!--						<button type="type" class="btn-collapse close"><span></span></button>-->
						<button type="type" class="reLoadFrm"></button>
					</div>
				</div>
			</div><!-- //contentsTop -->
			<form name="serchFrm" id="serchFrm" method="post" onSubmit="return false">
			<input type="hidden" name="atthType" id="atthType" th:value="${menuInfo.atthType}"/>
			<input type="hidden" name="atthNo" id="atthNo" >
			<input type="hidden" name="membNo" id="membNo" >
			<input type="hidden" name="sMembNo" id="sMembNo" />
			<input type="hidden" name="contrNo" id="contrNo" />
			<input type="hidden" name="guarNo" id="guarNo" th:value="${paramMap.guarNo}"/>
			<input type="hidden" name="guarPubDt" id="guarPubDt" value="" />
			<input type="hidden" name="decProc" id="decProc"/>
			<input type="hidden" name="guarType" id="guarType"/>
			<input type="hidden" name="pageType" id="pageType" value="dtl"/>	<!-- selectGuar에서 상세에서만 보증이력을 조회하기 위함 -->
			<input type="hidden" name="guarIssuCd" id="guarIssuCd"/> <!-- 발급유형(인터넷, 방문, G2B) -->

			<!-- 수정페이지 관련 -->
			<input type="hidden" name="procStat" id="procStat"/>
			<input type="hidden" name="guarClassCd" id="guarClassCd"/>
			<input type="hidden" name="guarReqCd" id="guarReqCd"/>

			<input type="hidden" name="guarIssueCd" id="guarIssueCd"/> <!-- g2b발송(재전송) 관련 -->
			<input type="hidden" name="publicNo" id="publicNo"/> <!-- 전자공고번호-->
			<input type="hidden" name="payProcType" id="payProcType"/> <!-- P 납입/ R 환불구분 -->

			<input type="hidden" name="talkProcStat" id="talkProcStat" /> <!-- 처리상태:알림톡전용 -->

			<div class="contents flex">
				<!--하단 버튼 영역-->
				<div class="layer-flex ">
					<!-- 처리 버튼 영역 -->
					<div class="" style="width:100%">
						<section class="area" id="btnArea">
							<!-- (버튼) 항상보이는 버튼 제외, 상세 조회값으로 컨트롤 중 -->
							<div class="fl">
								<th:block th:if="${session.posCd <= '50' || #strings.equals(session.posCd, '90')|| #strings.equals(session.userId, 'admin')}">
								<button type="button" id="examBtn" onclick="javascript:fnGuarExamConfirm();" class="btn style03" style="display:none;">심사 승인 확인</button>
								</th:block>

								<button type="button" id="setPayPartBtn" onclick="fnGuarPartNoPayProc();" class="btn style03" style="display:none;">납부미수처리</button>
								<button type="button" id="electSendBtn"  onclick="fnG2bSend();" class="btn style05" style="display:none;">재전송</button>
																<!-- 전결 버튼 필요(전결현황) -->
								<button type="button" id="decBtn" onclick="fnGuarDec();" class="btn style03" style="display:none;">전결처리</button>
							</div>
							<div >
								<button type="button" id="uptBtn" onclick="javascript:fnUpt();" class="btn style08" >수정</button>
								<button type="button" id="rpRetBtn" onclick="javascript:fnReport('RET');" class="btn style02" style="display:none;">보증료환불양식</button>
								<button type="button" id="rpRetCanBtn" onclick="javascript:fnReport('RETCAN');" class="btn style02" style="display:none;">해제환불양식</button>
								<button type="button" id="rpGuarBtn" onclick="javascript:fnReport('GUAR');" class="btn style02" style="display:none;">보증서</button>
								<button type="button" id="rpRcptBtn" onclick="javascript:fnReport('RCPT');" class="btn style02" style="display:none;">영수증</button>
								<button type="button" id="rpMsubsBtn" onclick="javascript:fnReport('MSUBS');" class="btn style02" >조합원청약서</button>
								<button type="button" id="rpSubsBtn" onclick="javascript:fnReport('SUBS');" class="btn style02">청약서</button>
								<button type="button" th:onclick="javascript:parent.closeMenu([[${menuInfo.menuIdx}]], [[${menuInfo.refMenuIdx}]])" class="btn style06" >닫기</button>
							</div>
						</section>
					</div>
					<!-- 처리 버튼 영역 끝-->
				</div>
				<div class="layer-flex collapseArea">
					<!-- 그리드 좌측 부분 시작 -->
					<div class="collapseBox" style="width:49%">
						<th:block th:include="com/comMemb"></th:block> <!--조합원조회 -->
						<th:block th:include="guar/comGuarDtl"></th:block> <!--보증상세정보 -->

						<section class="area mt10">
							<div class="fl">
								<h4 class="title">첨부파일<span style="font-size: 11px; color: #ff6600">(첨부할 파일을 끌어다 놓으시거나, 마우스 오른쪽버튼 -> '추가'로 첨부바랍니다.)</span></h4>
							</div>
							<div class="fr">
								<button type="button" onclick="javascript:com.fnDtlFileUpload('docFile', $('#atthType').val(), $('#atthNo').val(), $('#guarNo').val());" class="btn small style07">파일저장</button>
	                        	<button type="button" onclick="javascript:com.fnIbsFileDownAll($('#docFile'));" class="btn small style08">전체다운</button>
	                    	</div>
						</section>
						<div id="docFile" style="height:140px;"></div>
						<!-- 보증변경이력현황 -->
						<section class="area mt10">
							<div class="fl">
								<h4 class="title">보증변경현황</h4>
							</div>
						</section>
						<div id="sheetGuarDiv" style="width:100%;height:200px;"></div>

					</div>
					<!-- 그리드 좌측 부분 종료 -->

					<!-- 그리드 우측 부분 시작 -->
					<!--여긴 영역 감싼 버전으로 -->
					<!--fixScroll 스크롤 넣으면 안쪽영역으로 -->
					<div class="collapseBox fixable" style="width:49%">
						<div class="wrapBox">
							<th:block th:include="guar/comGuarContrDtl"></th:block> <!--보증약정정보 -->
						</div>
						<section class="area mt10">
							<div class="fl">
								<h4 class="title">보증상품정보</h4>
							</div>
							<div class="fr">
								<button type="button" onclick="guarCom.fnHideArea(this, 'tbl_guarLimit');" class="btn small style08">숨김</button>
							</div>
						</section>
						<table class="tbl" id="tbl_guarLimit"></table>

						<!-- 보증정보 구간 -->
						<div id="areaGuar">
							<!-- 심사정보 -->
							<section class="area mt10">
								<div class="fl">
									<h4 class="title">심사정보</h4>
								</div>
							</section>
							<table class="tbl">
								<colgroup>
									<col style="width:80px;">
									<col style="width:140px;">
									<col style="width:80px;">
									<col style="width:140px;">
									<col style="width:80px;">
									<col style="width:140px;">
								</colgroup>
								<tbody>
									<tr>
										<th>심사승인여부</th>
										<td><span id="ele_examYnNm"></span></td>
										<th>승인일자</th>
										<td><span id="ele_examDtm"></span></td>
										<th>승인자</th>
										<td><span id="ele_examNm"></span></td>
									</tr>
									<tr id="ele_decDirInfo" style="display:none;">
										<th>확인여부</th>
										<td><span id="ele_decDirYnNm"></span></td>
										<th>확인일자</th>
										<td><span id="ele_decDirDt"></span></td>
										<th>확인자</th>
										<td><span id="ele_decDirNm"></span></td>
									</tr>
									<tr id="ele_decMngInfo" style="display:none;">
										<th>전결여부</th>
										<td><span id="ele_decMngYnNm"></span></td>
										<th>전결일자</th>
										<td><span id="ele_decMngDt"></span></td>
										<th>전결자</th>
										<td><span id="ele_decMngNm"></span></td>
									</tr>
								</tbody>
							</table>
							<!-- 발급정보 -->
							<section class="area mt10">
								<div class="fl">
									<h4 class="title">발급정보</h4>
								</div>
							</section>
							<table class="tbl">
								<colgroup>
									<col style="width:80px;">
									<col style="width:140px;">
									<col style="width:80px;">
									<col style="width:140px;">
									<col style="width:80px;">
									<col style="width:140px;">
								</colgroup>
								<tbody>
									<tr>
										<th>처리상태</th>
										<td><span id="ele_procStatNm"></span></td>
										<th>심사일자</th>
										<td><span id="ele_guarApprDtm"></span></td>
										<th>심사자</th>
										<td><span id="ele_guarApprNm"></span></td>
									</tr>
									<tr>
										<th>처리사유</th>
										<td colspan="5"><span id="ele_procReason"></span></td>
									</tr>
									<tr>
										<th>발급일자</th>
										<td><span id="ele_guarPubDt"></span></td>
										<th>최근발급일시</th>
										<td><span id="ele_guarPubRecenDtm"></span></td>
										<th>발급횟수</th>
										<td><span id="ele_guarPubCnt"></span></td>
									</tr>

									<tr id="resMsgArea" style="display:none;">
						                <th>반려사유</th>
						                <td colspan="5"><span id="ele_resMsg"></span></td>
						            </tr>

								</tbody>
							</table>
						</div>
						<!-- 보증정보 구간 끝-->
						<!-- 해제 정보 부분 -->
						<div id="area_canInfo" style="display:none">
							<section class="area mt10">
								<div class="fl">
									<h4 class="title">해제정보</h4>
								</div>
							</section>
							<table class="tbl">
								<colgroup>
									<col style="width:80px;">
									<col style="width:140px;">
									<col style="width:80px;">
									<col style="width:140px;">
									<col style="width:80px;">
									<col style="width:140px;">
								</colgroup>
								<tbody>
									<tr>
						                <th>해제일자</th>
						                <td colspan="5"><span id="ele_guarCanDt"></span></td>
									</tr>
									<tr>
						                <th id="vCanReason">해제사유</th>
										<td colspan="5">
											<span id="ele_guarCanTypeNm"></span>
										</td>
									</tr>
									<tr>
										<th>해제비고</th>
										<td colspan="5"><span id="ele_retRmk"></span></td>
									</tr>
								</tbody>
							</table>
						<!-- 해제 정보 부분 끝 -->
						</div>

						<div id="area_canPart" style="display:none">
							<section class="area mt10">
								<div class="fl">
									<h4 class="title">일부해제현황</h4>
								</div>
							</section>
							<div id="sheetPartDiv" style="width:100%;height:100px;"></div>
						<!-- 해제 정보 부분 끝 -->
						</div>


						<th:block th:include="guar/comGuarPay"></th:block> <!--보증납부정보 -->

						<!--알림톡정보 : s-->
						<div id="alarmBox" class="wrapBox mt10">
							<th:block th:include="com/comAlarmTalk :: type('dtl')"></th:block> <!--알람톡정보 -->
							<!--<th:block th:include="com/comAlarmTalk :: type('invtSeprt')"></th:block> -->
						</div><!-- //wrapbox-->
						<!--알림톡정보 : e-->

						<!-- 보증이력(guarHistList) -->
						<div id="area_guarHist" style="display:none">
							<section class="area mt10">
								<div class="fl">
									<h4 class="title">보증변경이력</h4>
								</div>
							</section>
							<div id="sheetGuarHistDiv" style="width:100%; height:200px;"></div>
						</div>
						<!-- 전자보증이력 -->
						<div id="area_g2bHist" style="display:none">
							<section class="area mt10">
								<div class="fl">
									<h4 class="title">전자보증이력</h4>
								</div>
							</section>
							<div id="sheetDiv" style="width:100%; height:100px;"></div>
						</div>

						<!-- 그리드 우측 부분 끝 -->
					</div>
					<!-- 그리드 우측 부분 끝 -->
					<!-- END 컨텐츠 영역 -->
				</div>

			</div><!-- //contents -->
			</form>
		</div><!-- //contentsArea -->
	</body>
</html>

