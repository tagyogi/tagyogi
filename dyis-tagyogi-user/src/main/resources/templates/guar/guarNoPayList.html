<!--
	시스템구분 : 홈페이지 (콘텐츠 화면 처리 영역)
	파일정보 : guarNoPayList.html
	파일명 : guarNoPayList.html
	업무명 : 홈페이지 (콘텐츠 화면 처리 영역)
	생성자 : 변성균
	생성일 : 2023.08.11
-->
<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" xml:lang="ko">
	<script th:inline="javascript">
		/*<![CDATA[*/
		var codeList = /*[[${codeList}]]*/ //공통코드

		//화면 초기화 처리 호출
		$(document).ready(function(){
			//lnb 세팅함수
			fnPageLnbSet(/*[[${menuInfo}]]*/); //lnb세팅

			//com.fnCodeSelectBox("GR02", "sGuarStat", 1, ""); //보증상태
			com.fnCodeSelectBox("GR01", "sGuarType", 1, ""); //보증종류
			//$("#sGuarStat").find("option[value='10']").remove();	//처리중 삭제(미결제 현황은 10 조회가 없음)

			fnSerch();
		});

		var fnSerch = function(){
			//전체 체크박스 해제
			$("#chkAll").prop("checked", false);
			//console.log(JSON.stringify($("#serchFrm").serializeObject()));
			obj = {url:"/guarPay/selectGuarPayNoList.do", formId:"serchFrm", callBack:fnSerchCallBack, msgYn:"N", sessYn:"Y", loadYn:"Y"};
			com.fnAjaxPost(obj);

		}

		var fnSerchCallBack = function(resData){
			//console.log(resData);

			$("#ele_noPayList").empty();

			if(resData.data.length === 0) $("#ele_noPayList").append('<tr data-noData="Y"><td colspan="6">정보가 없습니다.</td></tr>');

			$.each(resData.data, function(index, item) {
				var paramTag  = 'data-guarNo="'+item.guarNo+'" data-guarType="'+item.guarType+'" data-docNo="'+item.docNo+'" data-guarTypeNm="'+item.guarTypeNm+'"';
					paramTag += ' data-contrNo="'+item.contrNo+'" data-procStat="'+item.procStat+'" data-guarIssueCd="'+ item.guarIssueCd+'" data-guarPubDt="' +item.guarPubDt + '"';
					paramTag += ' data-guarStat="'+item.guarStat+'" data-payYn="' +item.payYn+'" data-guarReqCd="'+item.guarReqCd+'" data-remainCommAmt="'+item.remainCommAmt+'"';

				var html  = '<tr onmouseover="this.className=\'mOver\'" onmouseout="this.className=\'mOut\'" style="cursor: pointer;" '+paramTag+'>';
					html += '<td class="alignC">';

					if(item.payYn === "Y"){
						html +=	'	<input type="checkbox" name="selChk" disabled/>'; 	//체크박스 - 완납시
					}else {
						html +=	'	<input type="checkbox" name="selChk" />'; 	//체크박스 - 미납 혹은 부분납시
					}


					html +=	'	<span style="display:none;">'+Number(index + 1)+'</span>';		//엑셀 다운용 번호 숨김처리
					html +=	'</td>';
					html += '<td class="alignC" style="text-overflow:ellipsis; overflow:hidden; white-space:nowrap;">';
					html += '<span style="display:block;">' + item.guarTypeNm + '</span>';//보증서종류
					html += '<span style="display:block;"> / ' + item.docNo + '</span>';//보증서번호
					html += '</td>';

					html += '<td class="alignC">';
					html += '<span style="display:block;">' + item.payYnNm + '</span>';//납부
					html += '<span style="display:block;"> / ' + com.fnDateFormat(item.guarPubDt) + '</span>';//발급일자
					html += '</td>';

					html += '<td class="alignR">';
					html += '<span style="display:block;">' + com.aprojomma(item.commAmt)  + '</span>';//결제금액
					html += '<span style="display:block;"> /' + com.aprojomma(item.remainCommAmt) + '</span>';//잔여금액
					html += '</td>';

					html += '<td class="alignL" style="text-overflow:ellipsis; overflow:hidden; white-space:nowrap;">';
					html += '<span style="display:block;text-overflow:ellipsis; overflow:hidden; white-space:nowrap;">' + fnAddServNmTag(item.guarIssueCd, item.chgCnt, item.servNm); + '</span>';//계약건명
					html += '<span style="display:block;"> /' + item.orderNm + '</span>';//피공제기관
					html += '</td>';

					html += '<td class="alignC"><span style="display:block;font-size: 13px; margin-bottom: 3px;">'+item.procStatNm+'</span>'
					//완납시 결제버튼 없애기
					if(item.payYn !== "Y"){
						html += '<button type="button" class="sub-btn small btn-color red" onclick="fnPayProc(this)">결제</button>'
					}
					html += '</td>;'

					//엑셀 다운로드 정보 숨김
					html += '<td class="alignC" style="display:none;">'+ com.fnNvlChk(item.reqNm) + '</td>'; //신청자

					html += '</tr>';

				$("#ele_noPayList").append(html);
			});

			$("#ele_listCnt").text(resData.data.length + " 건");

			//리스트 클릭 이벤트(tr 이벤트 걸면 버튼 or 체크박스 누를때 같이 눌러서 따로 정의)
			$("#ele_noPayList").find('tr > td').on("click", function(){
				var noData = $(this).closest('tr').data('noData'.toLowerCase());
				if(noData === "Y")	return;

				if($(this).find('button').length === 0 && $(this).find('input[type=checkBox]').length === 0) {	//버튼, 체크박스가 없으면
					//data는 소문자로 변환됨. 가독성을 위해 toLowerCase사용
					var param = {
						guarNo		: $(this).closest('tr').data('guarNo'.toLowerCase()),
						guarType	: $(this).closest('tr').data('guarType'.toLowerCase()),
						contrNo		: $(this).closest('tr').data('contrNo'.toLowerCase()),

						//상세 화면, 버튼 제어를 위한 파라미터(타임리프 문법 쓰기위해)
						procStat 	: $(this).closest('tr').data('procStat'.toLowerCase()),
						guarIssueCd : $(this).closest('tr').data('guarIssueCd'.toLowerCase()),
						guarStat 	: $(this).closest('tr').data('guarStat'.toLowerCase()),
						payYn 		: $(this).closest('tr').data('payYn'.toLowerCase()),
						guarReqCd 	: $(this).closest('tr').data('guarReqCd'.toLowerCase()),

						listNm		: /*[[${menuInfo.menuNm}]]*/,	//상세에서 left메뉴 on class주기위해 사용(메인 fnPageLnbSet() 호출시)
						returnPage	: /*[[${menuInfo.menuCd}]]*/	//돌아올 리스트페이지 정보(상세에서 목록 클릭시 이동할 메뉴 정보)
					};

					fnView(param);
				}


			});

			//(체크박스) 개별 클릭 이벤트
			$("input[name=selChk]").click(function(){
		        let total = $("input[name=selChk]").length;
		        let checked = $("input[name=selChk]:checked").length;

		        if(total !== checked) 	$("#chkAll").prop("checked", false);	//전체 해제
		        else 					$("#chkAll").prop("checked", true);		//전체 클릭
		    });

		    //(체크박스) 전체 클릭 이벤트
		    $("#chkAll").click(function() {
		        if($(this).is(":checked")) 	$("input[name=selChk]").not(':disabled').prop("checked", true);	// 체크시 전체 체크
		        else 						$("input[name=selChk]").prop("checked", false);	// 체크해제시 전체 체크해제
		    });

		}

		//(인터넷, G2B, 오프) + (변경 횟수)  + (계약건명) tag
		var fnAddServNmTag = function(guarIssueCd, chgCnt, servNm){
			//계약건명
			var tag = '';
			//인터넷, G2B, 창구 태그
			if(guarIssueCd === "I"){
				tag += '<span class="tagCss typeI">인</span>';
			}else if(guarIssueCd === "G"){
				tag += '<span class="tagCss typeG">G2B</span>';
			}else if(guarIssueCd === "V"){
				tag += '<span class="tagCss typeV">오프</span>';
			}
			//변경 상태 태그
			if(chgCnt !== '0'){
				tag += 	'<span class="tagCss">'+chgCnt+'</span>';
			}
			tag += servNm; //계약건명

			return tag;
		}

		//상세페이지 이동
		var fnView = function(param){
			//console.log(param);
			fnPage("2030214", param);
		}

		//결제창 이동(단건)
		var fnPayProc = function(obj){

			var guarArr = ""; //보증번호
			var remainCommAmt = 0; //보증료 합산 (잔여금액 remainCommAmt)
			var commCnt = 0; //건수
			var guarCont = ""; //결제상품명

			if(obj === undefined){ //다건 선택
				$("input[name=selChk]:checked").each(function(){
					if(guarArr === "") guarArr = $(this).closest('tr').data('guarNo'.toLowerCase());
					else guarArr += ":" + $(this).closest('tr').data('guarNo'.toLowerCase());

					remainCommAmt += Number($(this).closest('tr').data('remainCommAmt'.toLowerCase()));
					commCnt++;

					if(guarCont === "") guarCont = $(this).closest('tr').data('guarTypeNm'.toLowerCase());

				});

				if(guarArr === ""){
					alert("결제대상이 선택되지 않았습니다.");
					return;
				}

				if(commCnt === 1) guarCont = guarCont;
				else guarCont = guarCont + "외 " + Number(commCnt -1) + "건"
			}else{
				guarCont = $(obj).closest('tr').data('guarTypeNm'.toLowerCase()) //결제상품명
				guarArr = $(obj).closest('tr').data('guarNo'.toLowerCase()) //보증번호
				remainCommAmt = $(obj).closest('tr').data('remainCommAmt'.toLowerCase()) //금액
			}

			var param = {
				guarCont : guarCont
				, guarNo : guarArr
				, remainCommAmt : remainCommAmt
				, listNm		: /*[[${menuInfo.menuNm}]]*/
				, returnPage :  "2030224" //미결제현황

			};

			fnPage("2030225", param);
		}


		//발급
		var fnGuarIssue = function(obj){
			var guarType 	= $(obj).closest('tr').data('guarType'.toLowerCase());
			var guarNo 		= $(obj).closest('tr').data('guarNo'.toLowerCase());
			var pubDt 	= com.fnNvlChk($(obj).closest('tr').data('guarPubDt'.toLowerCase()), '');

			ozGuar(guarType, "", guarNo, pubDt);
		}

		//전송처리
		//var fnG2bSend = function(obj) {
		//	var param = {
		//		guarNo: $(obj).closest('tr').data('guarNo'.toLowerCase())
		//	};
		//	obj = {url:"/guarElect/sendGuarElect.do", param:param, callBack:fnSerch, msgYn:"N", sessYn:"Y", loadYn:"Y"};
		//	com.fnAjaxDef(obj);
		//}

		//엑셀 다운로드
		var fnExcel = function(){
			com.fnExcelToHtml("ele_noPayList",/*[[${menuInfo.menuNm + "_" + today}]]*/);
		};

		/*]]>*/
	</script>
        <div class="main-top sub">
			<ul class="inner">
                <li class="move1"></li>
                <li class="move2"></li>
                <li class="move3"></li>
                <li class="move4"></li>
                <li class="move5"></li>
            </ul>
        </div>
        <div class="content-wrap">
            <div class="inner">
                <div class="content-box flex-box jc-between">
                    <!-- 업무 안내 영역 -->
                    <div id="lnb" class="lnb-wrap">
                        <h3 class="ko-bold h3-txt"></h3>

                    </div>

                    <!-- 업무 안내 영역 끝 -->
                    <div class="content-main">
						<!-- 경로 영역 시작 -->
                        <div th:insert="~{/fragments/subTitle}"></div>
                        <!-- 경로 영역 끝 -->
                        <form name="serchFrm" id="serchFrm" onSubmit="return false">
						<input type="hidden" th:name="_csrf" th:value="${_csrf?.token}"/>
						<input type="hidden" name="sMembNo" id="sMembNo" th:value="${session.membNo}"/>
						<input type="hidden" name="sGuarPayYn" id="sGuarPayYn" value="N"/>
                        <section id="content" class="content">
                            <!-- 여기서부터 content -->
                            <div>
                                <article>
									<div class="search-wrap txt-border-wrap">
                                        <table class="block">
                                            <colgroup>
                                            	<col style="width:10%;">
                                            	<col style="width:35%;">
                                            	<col style="width:10%;">
                                            	<col style="width:20%;">
                                            </colgroup>
                                            <tbody>
												<tr>
                                                    <th>발급일자</th>
                                                    <td>
                                                        <div class="flex-box al-center gap-5">
                                                            <div class="flex-box al-center">
                                                                <input type="text" name="sSerchStaDt" id="sSerchStaDt" value="" class="w-100" title="발급날짜 입력" placeholder="YYYY-MM-DD" maxlength="10" onkeyup="com.fnOnlyNum(this);com.fnDateMakeForm(this)" onblur="com.fnDateValiChk(this);" style="width:120px;" autocomplete="off"/>
                                                            	<img src="../images/icon_calendar.png" alt="달력" class="calendar-box" onclick="calendar(this, 'sSerchStaDt', 'yyyy-mm-dd','sSerchEndDt', 1)" />
                                                            </div>
                                                            ~
                                                            <div class="flex-box al-center">
                                                                <input type="text" name="sSerchEndDt" id="sSerchEndDt" value="" class="w-100" title="결제일 입력" placeholder="YYYY-MM-DD" maxlength="10" onkeyup="com.fnOnlyNum(this);com.fnDateMakeForm(this)" onblur="com.fnDateValiChk(this);" style="width:120px;" autocomplete="off"/>
                                                            	<img src="../images/icon_calendar.png" alt="달력" class="calendar-box" onclick="calendar(this, 'sSerchEndDt', 'yyyy-mm-dd','sSerchStaDt', 2)" />
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <th class="ko-bold">보증서종류</th>
                                                    <td>
														<select name="sGuarType" id="sGuarType" class=" w-100"></select>
                                                    </td>
                                                    <!--<th class="ko-bold">보증상태</th>
                                                    <td>
														<select name="sGuarStat" id="sGuarStat" class=" w-100"></select>
                                                    </td>-->
                                                </tr>
                                                <tr>
                                                    <th>계약건명</th>
                                                    <td>
														<input type="text" name="sServNm" id="sServNm" value="" class="w-100" title="계약건명 입력" maxlength="100">
                                                    </td>
                                                    <th>피공제기관</th>
                                                    <td>
														<input type="text" name="sOrderNm" id="sOrderNm" value="" class="w-100" title="피공제기관 입력" maxlength="50">
                                                    </td>
                                                </tr>
                                                <tr>
                                                    <th>보증서번호</th>
                                                    <td>
														<input type="text" name="sDocNo" id="sDocNo" title="보증서번호" maxlength="25" class="w-100" value=""/>
                                                    </td>
                                                    <th>완납여부</th>
                                                    <td>
														<select name="sPayYn" id="sPayYn" class="w-100">
															<option value="N" selected>미납(부분납)</option>
															<option value="Y">완납</option>
														</select>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                        <div class="alignR btn-position">
											<button type="button" class="sub-btn btn-color m-w-100 m-mb5 red onlyPc" onClick="fnPayProc()">결제</button>
											<button type="button" class="sub-btn btn-color m-w-100 m-mb5 green btn-auto fs-0" onClick="fnExcel()">Excel</button>
											<button type="button" class="sub-btn btn-black m-w-100" onClick="fnSerch()">검색</button>
										</div>
                                    </div>
                                </article>
                                <article>
                                    <p class="title-dept1" id="ele_listCnt"></p>
                                    <div class="table-wrap board">
                                        <div class="table-scroll v2">
                                            <table class="border">
												<colgroup>
	                                            	<col style="width:2%;">
	                                            	<col style="width:8%;">
	                                            	<col style="width:5.5%;">
	                                            	<col style="width:6%;">
	                                            	<col style="width:22%;">
	                                            	<col style="width:5%;">
	                                            </colgroup>
                                                <thead class="back-gray">
                                                    <tr>
                                                        <th scope="col" data-width="30"><input type="checkbox" id="chkAll"><span style="display:none;">번호</span></th>	<!-- 엑셀 다운용 제목 숨김처리 -->
                                                        <th scope="col" data-width="60">보증서종류/번호</th>
                                                        <th scope="col" data-width="200">납부/발급일자</th>
                                                        <th scope="col" data-width="60">결제/잔여 금액</th>
														<th scope="col" data-width="60">계약건명/피공제기관</th>
														<th scope="col" data-width="60">처리상태</th>
														<!-- 엑셀 다운로드영역 숨김처리 -->
														<th scope="col" style="display:none;" data-width="60">신청자</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="ele_noPayList"></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </article>
                            </div>
                        </section>
                        </form>
                    </div>
                </div>
            </div>
        </div>
</html>