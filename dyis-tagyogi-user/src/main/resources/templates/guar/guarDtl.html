<!--
	시스템구분 : 홈페이지 (콘텐츠 화면 처리 영역)
	파일정보 : guarDtl.html
	파일명 : guarDtl.html
	업무명 : 홈페이지 (콘텐츠 화면 처리 영역)
	생성자 : 권다슬
	생성일 : 2023.08.29
-->
<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" xml:lang="ko">
	<th:block th:layout="comjs">
		<script th:src="@{/js/guarCom.js}"></script>
	</th:block>
	<script th:inline="javascript">
		/*<![CDATA[*/
		var codeList = /*[[${codeList}]]*/; //공통코드
		var guarType = /*[[${paramMap.guarType}]]*/; //보증상품
		var guar = "";
		
		//화면 초기화 처리 호출
		$(document).ready(function(){
			//lnb 세팅함수
			fnPageLnbSet(/*[[${menuInfo}]]*/, /*[[${paramMap.listNm}]]*/); //lnb세팅

			//동적 첨부파일 (다건)
			com.fnIbsUpload($("#docFile"));

			//보증정보 조회
			fnSelectGuar();
		});

		//보증정보 조회
		var fnSelectGuar = function(){
			obj = {url:"/guar/selectGuar.do", formId:"serchFrm", callBack:fnGuarInscallback, msgYn:"N", sessYn:"Y", loadYn:"Y"};
			com.fnAjaxPost(obj);
		}

		//보증신청정보 조회 콜백
		var fnGuarInscallback = function(resData){
			//console.log(resData);
			guar = resData.guar;
			//0. 보증 정보 화면 구성(guar/comGuarDtl.html)
			fnGuarContrViewSet(resData);

			//1-1. 조합원
			var memb = /*[[${session}]]*/
			com.fnSetKeyVal(memb);

			//1-2. 조합원(약정정보)
			com.fnSetKeyVal(resData.contr, "area_comGuarMemb");

			//1-3. 조합원(보증한도, 보증사용액, 보증가능액)
			com.fnSetKeyVal(resData.contrLimit, "area_comGuarMemb");

			//2. 보증 정보
			com.fnSetKeyVal(resData.guar);
			guarCom.fnGuarIssueChg(resData.guar.guarIssueCd);	//계약번호 표시방법
			com.checkBoxCheckValue(resData.guar.chgDispYn, "chgDispYn");	//변경분 표시

			//3. 첨부파일
			com.fnIbsUploadView($("#docFile"), resData.fileList);
			
			//알림톡세팅
			var setParam = {membNo: $("#membNo").val(), setTalk:"Y", setVal:resData.guar.talkNm}
			com.fnSetPersList(setParam);
			
			
		}

		//레포트
		var fnReport = function(type){
			var membNo = $("#membNo").val();
			var guarNo = $("#guarNo").val();
			var pubDt = $("#guarPubDt").val();

			if(type === "GUAR"){	//보증서출력
				ozGuar(guarType, "", guarNo, pubDt);
			}else if(type === "RCPT"){ //영수증
				ozLoad("GR_영수증_(공제계약자_보관용)", ["guar_no"], [guarNo], 1, "pdf", "");
			}else if(type === "SUBS"){ //청약서
				//ozGuarSubs("", guarType, guarNo);
				ozGuar(guarType, 10, guarNo, pubDt);
			}else if(type === "SUCC"){ //이행완료확인서
				ozLoad("GR_확인서_이행완료", ["guar_no"], [guarNo], 1, "pdf", "");
			}
		}

		//결제창 이동
		var fnPayProc = function(obj){
			var param = {
				guarCont : $('#guarCont').val() //결제상품명
				, guarNo : $("#guarNo").val()//보증번호
				, remainCommAmt : $('#remainCommAmt').val() //금액
				, listNm		: /*[[${paramMap.listNm}]]*/
				, returnPage :  /*[[${paramMap.returnPage}]]*/

			};

			fnPage("2030225", param);
		}

		//전자보증서 전송
		var fnG2bSend = function(){
		    if(!confirm("정말로 선택하신 " + guarCom.fnSelectGuarTypeNm(guarType) + "서를 전송하시겠습니까?")) return;

			var param = { guarNo: $("#guarNo").val() };
			obj = {url:"/guarElect/sendGuarElect.do", param:param, callBack:fnG2bSendCallBack, msgYn:"N", sessYn:"Y", loadYn:"Y"};
			com.fnAjaxDef(obj);
		}

		//전자보증서 전송 콜백
		var fnG2bSendCallBack = function(resData){
			fnMovePage('LIST');
		}

		//리스트 페이지 이동
		var fnMovePage = function(type){
			var pageCd = "";
			var guarNo = guar.guarNo;
			
			if(type === 'LIST'){	//리스트 페이지 이동(목록 버튼)
				pageCd = /*[[${paramMap.returnPage}]]*/;
				param = undefined;
			}else if(type === 'UPT'){	//수정(신청 procStat < 20 일때만 접근중)

				var guarClassCd = $("#guarClassCd").val();
				if(guarClassCd === "10")			pageCd = "2030213";	//신청수정 (guar/guarReqUpt.html)
				else if(guarClassCd === "60")	pageCd = "2030217";	//기재변경수정 (guar/guarChgDescUpt.html)
				else							pageCd = "2030220"; //변경수정 (guar/guarChgUpt.html)

			}else if(type === 'CHG'){	//변경신청(배서)
				guarNo = guar.lastGuarNo;
				pageCd = '2030219';	//guar/guarChgIns.html
			}else if(type === 'DESC'){	//기재변경신청
				guarNo = guar.lastGuarNo;
				pageCd = '2030216';	//guar/guarChgDescIns.html
			}

			if(pageCd === "")	return;

			var param = { guarNo: guarNo, contrNo: $("#contrNo").val(), listNm: /*[[${paramMap.listNm}]]*/, returnPage: /*[[${paramMap.returnPage}]]*/,
						  refVal: String(guarType) };	//comGuarReq.html에서 사용 (보증신청페이지와 같이 사용해야해서 refVal변수로 넘김)

			fnPage(pageCd, param);
		}

		//보증 삭제(신청단계에서만 버튼 보임)
		var fnDel = function(){
			if(!confirm("신청한 " + guarCom.fnSelectGuarTypeNm(guarType) + " 정보를 삭제하시겠습니까?")) return;

			var deleteParam = { guarNo: $("#guarNo").val(), atthNo: $("#atthNo").val(), atthType:/*[[${menuInfo.atthType}]]*/ };
			var obj = {url:"/guar/deleteGuar.do", param:deleteParam, callBack:fnDelCallBack, msgYn:"Y", sessYn:"Y", loadYn:"Y"};
			com.fnAjaxDef(obj);
		}

		//보증 삭제 콜백
		var fnDelCallBack = function(){
			fnMovePage('LIST');
		}

		/*]]>*/
	</script>
        <div class="main-top sub">
			<ul class="inner">
                <li class="move1"></li>
                <li class="move2"></li>
                <li class="move3"></li>
                <li class="move4"></li>
                <li class="move5"></li>
            </ul>
        </div>
        <div class="content-wrap">
            <div class="inner">
                <div class="content-box flex-box jc-between">
                    <!-- 업무 안내 영역 -->
                    <div id="lnb" class="lnb-wrap">
                        <h3 class="ko-bold h3-txt"></h3>

                    </div>

                    <!-- 업무 안내 영역 끝 -->
                    <div class="content-main">
						<!-- 경로 영역 시작 -->
                        <div th:insert="~{/fragments/subTitle}"></div>
                        <!-- 경로 영역 끝 -->
                        <form name="serchFrm" id="serchFrm" onSubmit="return false">
							<input type="hidden" th:name="_csrf" th:value="${_csrf?.token}"/>
							<input type="hidden" name="guarNo" 			id="guarNo" 	  th:value="${paramMap.guarNo}"/>
							<input type="hidden" name="contrNo" 		id="contrNo" 	  th:value="${paramMap.contrNo}"/>
							<input type="hidden" name="membNo" 			id="membNo" 	  th:value="${session.membNo}"/>
							<input type="hidden" name="sMembNo" 		id="sMembNo" 	  th:value="${session.membNo}"/>
							<input type="hidden" name="atthType" 		id="atthType" 	  th:value="${menuInfo.atthType}"/>

							<input type="hidden" name="guarPubDt" 		id="guarPubDt"/>	<!-- 청약서 출력용 -->
							<input type="hidden" name="atthNo" 			id="atthNo"/>		<!-- 보증 삭제용 -->
							<input type="hidden" name="guarClassCd" 	id="guarClassCd"/>	<!-- 수정페이지 구분용 -->
							<input type="hidden" name="remainCommAmt" 	id="remainCommAmt"/>		<!-- 결제창 이동 정보 -->
							<input type="hidden" name="guarCont" 		id="guarCont"/>		<!-- 결제창 이동 정보 -->

	                        <section id="content" class="content">
	                            <!-- 여기서부터 content -->
	                            <div>
	                                <article>
										<th:block th:include="guar/comGuarMemb"></th:block>
	                                </article>
	                                <article>
	                                    <p class="title-dept1">보증서 신청정보</p>
	                                    <div class="table-wrap info">
	                                        <div class="table-scroll">
	                                            <table summary="보증서 신청정보">
	                                                <colgroup>
	                                                    <col width="13%">
	                                                    <col width="38%">
	                                                    <col width="13%">
	                                                    <col width="36%">
	                                                </colgroup>
	                                                <tbody>
	                                                    <tr>
	                                                        <th>신청유형</th>
	                                                        <td><span id="ele_guarReqCdNm"></span></td>
	                                                        <th>처리상태</th>
	                                                        <td><span id="ele_procStatNm"></span></td>
	                                                    </tr>
	                                                    <tr>
	                                                        <th>신청방법</th>
	                                                        <td><span id="ele_guarIssueCdNm"></span></td>
	                                                        <th>계약번호</th>
	                                                        <td>
																<div id="ele_g2bNone" style="display:none">해당사항없음</div>
																<div id="ele_g2b" style="display:none">
																	<span id="ele_publicNo"></span>
																</div>
															</td>
	                                                    </tr>
	                                                    <tr>
	                                                        <th>신청자명</th>
	                                                        <td><span id="ele_reqNm"></span></td>
	                                                        <th>신청자연락처</th>
	                                                        <td><span id="ele_reqTel"></span></td>
	                                                    </tr>
														<th:block th:if="${#strings.equals(paramMap.guarReqCd, '2')}">
														<tr>
									                    <th>변경구분</th>
									                        <td><span id="ele_guarClassCdNm"></span></td>
									                        <th>이전보증서</th>
									                        <td><span id="ele_befDocNo"></span></td>
									                    </tr>
									                    <tr>
									                        <th>기존계약금액</th>
									                        <td><span id="ele_befContrAmt"></span></td>
									                        <th>기존보증금액</th>
									                        <td><span id="ele_befGuarAmt"></span></td>
									                    </tr>
									                    <tr>
									                        <th>기존보증기간</th>
									                        <td colspan="3">
																<span id="ele_befGuarBegDt"></span> ~ <span id="ele_befGuarExpDt"></span>&nbsp;(<span id="ele_befGuarDays"></span>일)
									                        </td>
									                    </tr>
														</th:block>
	                                                </tbody>
	                                            </table>
	                                        </div>
	                                    </div>
	                                </article>

                                    <!--보증상세정보 (추가보증 정보 포함)-->
									<th:block th:include="guar/comGuarDtl"></th:block>

	                                <article>
	                                    <p class="title-dept1">첨부파일</p>
										<div id="docFile" style="height:140px;"></div>
	                                </article>
	                                
	                                <!--알림톡정보 : s-->
									<th:block th:include="com/comAlarmTalk :: type('dtl')"></th:block> 
									<!--알림톡정보 : e-->

	                                <div class="btn-wrap flex-box jc-end gap-10 m-col">
										<button type="button" class="sub-btn2 btn-color orange onlyPc" onclick="fnReport('SUCC');">완료확인서</button>
										<button type="button" class="sub-btn2 btn-color orange onlyPc" onclick="fnReport('RCPT');">영수증출력</button>
										<button type="button" class="sub-btn2 btn-color orange onlyPc" onclick="fnReport('SUBS')">청약서출력</button>

										<th:block th:if="${paramMap.procStat >= 40}">	<!-- (#strings.equals(paramMap.procStat,'40') || #strings.equals(paramMap.guarIssueCd, 'I')) &&  -->
										<button type="button" class="sub-btn2 btn-color orange onlyPc" onclick="fnReport('GUAR')">보증서출력</button>
										</th:block>

										<th:block th:if="${#strings.equals(paramMap.procStat, '41') || #strings.equals(paramMap.procStat, '42') || #strings.equals(paramMap.procStat, '80') || #strings.equals(paramMap.procStat, '90')}">
											<th:block th:if="${not #strings.equals(paramMap.guarType, '11') && not #strings.equals(paramMap.guarType, '13')}">
						                	<button type="button" class="sub-btn2 btn-color blue onlyPc" onclick="fnMovePage('CHG')">변경신청</button>
											</th:block>
						                </th:block>

										<th:block th:if="${#strings.equals(paramMap.procStat, '41') || #strings.equals(paramMap.procStat, '42') || #strings.equals(paramMap.procStat, '80') || #strings.equals(paramMap.procStat, '90')}">
										<button type="button" class="sub-btn2 btn-color blue onlyPc" onclick="fnMovePage('DESC')">기재변경신청</button>
										</th:block>

										<th:block th:if="${#strings.equals(paramMap.procStat, '40') && #strings.equals(paramMap.guarIssueCd, 'G')}">
										<button type="button" class="sub-btn2 btn-color green onlyPc" onclick="fnG2bSend()">보증서전송</button>
										</th:block>

										<th:block th:if="${(#strings.equals(paramMap.procStat, '30') || #strings.equals(paramMap.procStat, 'H')) && !#strings.equals(paramMap.procStat, '31')}">
										<button type="button" class="sub-btn2 btn-color red onlyPc" onclick="fnPayProc()">결제</button>
										</th:block>

										<th:block th:if="${paramMap.procStat < 20}">
						                <button type="button" class="sub-btn2 btn-color blue onlyPc" onclick="fnMovePage('UPT')">수정</button>
										<button type="button" class="sub-btn2 btn-color onlyPc" onclick="fnDel()">삭제</button>
										</th:block>

										<button type="button" class="sub-btn2 btn-white" onclick="fnMovePage('LIST')">목록</button>
	                                </div>
	                            </div>
	                        </section>
                        </form>
                    </div>
                </div>
            </div>
        </div>
</html>