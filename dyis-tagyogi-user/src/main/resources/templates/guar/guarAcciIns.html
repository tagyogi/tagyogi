<!--
	시스템구분 : 홈페이지
	파일정보 : guarAcciIns.html
	파일명 : guarAcciIns.html
	업무명 : 공제금신청현황
	생성자 : 변성균
	생성일 : 2023.08.11
-->
<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" xml:lang="ko">

	<script th:inline="javascript">
		/*<![CDATA[*/
		var codeList = /*[[${codeList}]]*/ //공통코드
		var acciBizNo = /*[[${paramMap.acciBizNo}]]*/

		//화면 초기화 처리 호출
		$(document).ready(function(){
			//lnb 세팅함수
			fnPageLnbSet(/*[[${menuInfo}]]*/, '공제금신청'); //lnb세팅

			com.fnCodeSelectBox("GR01", "guarType", 1, ""); //
			com.fnCodeSelectBox("AC02", "payWayCd", 1, ""); //
			com.fnCodeSelectBox("CM02", "payBankCd", 1, ""); //

			$("#payWayCd > option[value='10']").prop("disabled", true);

		});

		//보증내역조회
		var fnGuarConfirm = function(){

			//필수값체크
			if($('#guarPubDt').val() === "" || $("#guarPubDt").val().length !== 10){
				alert("발급일자를 입력(선택)해 주십시오.");
				$("#guarPubDt").focus();
				return false;
			}

			if($('#accDocNo').val() === ""){
				alert("보증증권번호를 입력해 주십시오.");
				$("#accDocNo").focus();
				return false;
			}

			if($('#guarType').val() === ""){
				alert("보증종류를 선택해 주십시오.");
				$("#guarType").focus();
				return false;
			}


			obj = {url:"/acciGuar/selectAcciGuarConfirm.do", formId:"serchFrm", callBack:fnGuarConfirmBack, msgYn:"N", sessYn:"N", loadYn:"Y"};
			com.fnAjaxPost(obj);

		}

		//보증내역조회 콜백
		var fnGuarConfirmBack = function(resData){
			//console.log(resData);
			if(resData.data === null || resData.data.length <= 0){
				alert("조회된 보증내역이 존재하지않습니다.");
				return;
			}

			if(resData.data.orderBizNo === ""){
				alert("공제금 신청을 위한 피공제자 정보가 누락되어 있습니다. \n 공제사업팀에 문의하여 주시기 바랍니다.");
				return;
			}if(resData.data.orderBizNo !== $("#orderBizNo").val()){
				alert('기관인증을 완료한 피공제기관에한하여 공제금신청이 가능합니다.\n 조회된 보증내역의 피공제기관과 인증완료한 기관이 다릅니다.');
				return;
			}
			else {

				$("#guarTerm").val(com.fnDateFormat(resData.data.guarBegDt) + "~" + com.fnDateFormat(resData.data.guarExpDt));
                $("#guarAmt").val(resData.data.guarAmt);
                $("#servNm").val(resData.data.servNm);
                $("#orderNm").val(resData.data.orderNm);

                $("#membNo").val(resData.data.membNo);
                $("#membNm").val(resData.data.membNm);

                $("#accGuarNo").val(resData.data.guarNo);
                $("#accContrNo").val(resData.data.contrNo);
                //$("#idn").val($(this).find("ORDER_BIZ_NO").text());

                $("#orderName").val(resData.data.orderNm);
                $("#orderBizNo").val(resData.data.orderBizNo);

                $.each($(".setCommaCls"), function(idx,item){
					$(item).text($(item).text() === null ? "0":com.aprojomma($(item).text()));
					$(item).val($(item).val() === null ? "0":com.aprojomma($(item).val()));
				});

				$.each($(".setDateCls"), function(idx,item){
					$(item).text($(item).text() === null ? "-":com.fnDateFormat($(item).text()));
					$(item).val($(item).val() === null ? "-":com.fnDateFormat($(item).val()));
				});

				//보증내역조회버튼
				$("#guarConfirmBtn").hide();
				$("#accDocNo, #guarPubDt, #guarType").prop("readonly", true);
				$("#guarType").prop("disabled", true);

			}

		}

		//신청(저장)
		var fnSave = function(){

			//필수값체크
			if($("#accGuarNo").val() === ""){
		        alert("보증정보를 조회해 주십시오.");
		        return;
		    }

		    if($("#claimAmt").val() === ""){
		        alert("청구금액을 입력해 주십시오.");
		        $("#claimAmt").focus();
		        return;
		    }

		    if($("#accReqNm").val() === ""){
		        alert("신청(담당)자명을 입력해 주십시오.");
		        $("#accReqNm").focus();
		        return;
		    }

		    if($("#accReqTel").val() === ""){
		        alert("연락처를 입력해 주십시오.");
		        $("#accReqTel").focus();
		        return;
		    }

		    if(confirm("해당 보증건에 대하여 공제금을 신청하시겠습니까?")){

				let plan =  "사고증권번호 : "	+ $("#accDocNo").val() + "\n" +
							"발급일자 : " 		+ $("#guarPubDt").val() + "\n" +
							"보증번호 : "		+ $("#accGuarNo").val() + "\n" +
							"청구일자 : "		+ $("#claimDt").val() + "\n" +
							"청구금액 : "		+ $("#claimAmt").val() + "\n" +
							"신청자명 : "		+ $("#accReqNm").val() + "\n" +
							"연락처  : "	    + $("#accReqTel").val() + "\n" +
							"청구내용 : "		+ $("#claimCont").val() + "\n" +
							"입금방법 : "		+ $("#payWayCd option:checked").text() + "\n" +
							"예금주  : "		+ $("#payNm").val() + "\n" +
							"입금은행 : "		+ $("#payBankCd option:checked").text() + "\n" +
							"입금계좌 : "		+ $("#payAcct").val() + "\n"
							;

				//console.log(plan);
				param = {plan:plan, idn: $("#orderBizNo").val()};  //기관인증한 사업자번호로 우선 처리
				com.fnCertSign(param); //전자서명 처리
			}

		}

		//서명 콜백
		var fnCertSingCallBack = function(resData){
			//console.log(resData);
			$("#signData").val(resData.signData);

			var param = $("#serchFrm").serializeObject();
			//console.log(param);
			obj = {url:"/acciGuar/insertAcciGuarMaster.do", callBack:fnSaveCallBack, param:param, msgYn:"Y", sessYn:"Y", loadYn:"Y" };
			com.fnAjaxDef(obj);
		}

		//저장처리콜백
		var fnSaveCallBack = function(resData){
			//console.log('저장성공');

			var param = {};
			param.acciBizNo = acciBizNo;

			fnPage('2030504', param);
		}


		//목록으로
		var fnRepage = function(){

			//공인인증서 로그인 안한상태로 신청화면 => 목록으로 돌아오는경우는 기관인증 화면으로 이동
			if(acciBizNo === "" || acciBizNo === undefined){
				fnPage('2030503');
			}else {
				var param = {};
				param.acciBizNo = acciBizNo;

				fnPage('2030504', param);
			}


		}

		/*]]>*/
	</script>
        <div class="main-top sub">
			<ul class="inner">
                <li class="move1"></li>
                <li class="move2"></li>
                <li class="move3"></li>
                <li class="move4"></li>
                <li class="move5"></li>
            </ul>
        </div>
        <div class="content-wrap">
            <div class="inner">
                <div class="content-box flex-box jc-between">
                    <!-- 업무 안내 영역 -->
                    <div id="lnb" class="lnb-wrap">
                        <h3 class="ko-bold h3-txt"></h3>

                    </div>

                    <!-- 업무 안내 영역 끝 -->
                    <div class="content-main">
						<!-- 경로 영역 시작 -->
                        <div th:insert="~{/fragments/subTitle}"></div>
                        <!-- 경로 영역 끝 -->
                        <form name="serchFrm" id="serchFrm" onSubmit="return false">
						<input type="hidden" th:name="_csrf" th:value="${_csrf?.token}"/>
						<input type="hidden" name="signedCont" id="signedCont" value=""/>
		                <input type="hidden" name="membNo" id="membNo" />
		                <input type="hidden" name="membNm" id="membNm" />
		                <input type="hidden" name="orderBizNo" id="orderBizNo" th:value="${paramMap.acciBizNo}" />
						<input type="hidden" name="accGuarNo" id="accGuarNo" />
						<input type="hidden" name="accContrNo" id="accContrNo" />

                        <section id="content" class="content">
                            <!-- 여기서부터 content -->
                            <div>
                                <article>
	                                <p class="title-dept1">보증정보</p>
	                                <div class="table-wrap info">
	                                    <div class="table-scroll">
	                                        <table width="100%">
												<colgroup>
	                                                <col style="width:12%;">
	                                                <col style="width:auto;">
	                                                <col style="width:12%;">
	                                                <col style="width:auto;">
	                                            </colgroup>
	                                            <tbody>
													<tr>
	                                                    <th>보증정보조회</th>
	                                                    <td colspan="3">증권번호와 발급일자를 입력하신 후 보증정보를 먼저 조회하시기 바랍니다.</td>
	                                                </tr>
	                                                <tr>
	                                                    <th>사고증권번호</th>
	                                                    <td>
															<input type="text" name="accDocNo" id="accDocNo" value="" title = "사고증권번호" maxlength="20"/>
														</td>
	                                                    <th >발급일자</th>
	                                                    <td>
															<div class="al-center datepicker-wrap" style="width:170px" >
																<input type="text" name="guarPubDt" id="guarPubDt" th:value="${today}" title="발급일자" maxlength="10" placeholder="YYYY-MM-DD" onkeyup="com.fnOnlyNum(this);com.fnDateMakeForm(this);" onblur="com.fnDateValiChk(this)" style="width:120px;" autocomplete="off"/>
																<img src="../images/icon_calendar.png" alt="달력" class="calendar-box" onclick="calendar(this, 'guarPubDt', 'yyyy-mm-dd')" />
	                                                        </div>
														</td>
	                                                </tr>
	                                                <tr>
	                                                    <th >보증종류</th>
	                                                    <td colspan="3">
															<select id="guarType" name="guarType" style="width: 300px;"></select>
															<button type="button" id="guarConfirmBtn" class="btn-white sub-btn" onclick="fnGuarConfirm();" style="font-size: 13px;">보증내역조회</button>
														</td>
	                                                </tr>
	                                                <tr>
	                                                    <th>보증기간</th>
	                                                    <td>
															<input type="text" name="guarTerm" id="guarTerm" value="" readonly />
														</td>
	                                                    <th >보증금액</th>
	                                                    <td>
															<input type="text" name="guarAmt" id="guarAmt" class="setCommaCls" value="" onkeyup="com.fnOnlyNum(this);com.makeComma(this);" readonly="readonly" maxlength="15">
														</td>
	                                                </tr>
	                                                <tr>
	                                                    <th>계약건명</th>
	                                                    <td>
															<input type="text" name="servNm" id="servNm" value="" readonly="readonly">
														</td>
	                                                    <th >피공제기관</th>
	                                                    <td>
															<input type="text" name="orderNm" id="orderNm" value="" readonly="readonly">
														</td>
	                                                </tr>
	                                            </tbody>
	                                        </table>
	                                    </div>
	                                </div>
	                            </article>

	                            <!--청구정보-->
	                            <article>
	                                <p class="title-dept1">청구정보</p>
	                                <div class="table-wrap info">
	                                    <div class="table-scroll">
	                                        <table width="100%">
												<colgroup>
	                                                <col style="width:12%;">
	                                                <col style="width:auto;">
	                                                <col style="width:12%;">
	                                                <col style="width:auto;">
	                                            </colgroup>
	                                            <tbody>
	                                                <tr>
	                                                    <th>청구일자</th>
	                                                    <td>
															<div class="al-center" style="width:170px" >
																<input type="text" name="claimDt" id="claimDt" th:value="${today}" title="청구일자" maxlength="10" placeholder="YYYY-MM-DD" onkeyup="com.fnOnlyNum(this);com.fnDateMakeForm(this);" onblur="com.fnDateValiChk(this)" style="width:120px;" autocomplete="off"/>
																<img src="../images/icon_calendar.png" alt="달력" class="calendar-box" onclick="calendar(this, 'claimDt', 'yyyy-mm-dd')" />
	                                                        </div>
														</td>
	                                                    <th >청구금액</th>
	                                                    <td>
															<input type="text" name="claimAmt" id="claimAmt" value="" onkeyup="com.fnOnlyNum(this);com.makeComma(this);" maxlength="15">
														</td>
	                                                </tr>
	                                                <tr>
	                                                    <th>신청(담당)자명</th>
	                                                    <td>
															<input type="text" name="accReqNm" id="accReqNm" value="" maxlength="20">
														</td>
	                                                    <th >연락처</th>
	                                                    <td>
															<input type="text" name="accReqTel" id="accReqTel" size="14" maxlength="15" value="" onkeyup="com.fnOnlyNum(this);com.makeTelNo(this)" >
														</td>
	                                                </tr>
	                                                <tr>
	                                                    <th>청구내용</th>
	                                                    <td colspan="3">
															<!--<input type="text" name="claimCont" id="claimCont" value="" >-->
															<textarea name="claimCont" id="claimCont" cols="45" rows="5" style="width:100%;" maxlength="2000" ></textarea>
														</td>
	                                                </tr>
	                                            </tbody>
	                                        </table>
	                                    </div>
	                                </div>
	                            </article>

	                            <!--공제금수령정보-->
	                            <article>
	                                <p class="title-dept1">공제금수령정보</p>
	                                <div class="table-wrap info">
	                                    <div class="table-scroll">
	                                        <table width="100%">
												<colgroup>
	                                                <col style="width:12%;">
	                                                <col style="width:auto;">
	                                                <col style="width:12%;">
	                                                <col style="width:auto;">
	                                            </colgroup>
	                                            <tbody>
	                                                <tr>
	                                                    <th>입금방법</th>
	                                                    <td >
															<select id="payWayCd" name="payWayCd"></select>
														</td>
	                                                    <th>예금주</th>
	                                                    <td>
															<input type="text" name="payNm" id="payNm" value="" maxlength="20" >
														</td>
	                                                </tr>
	                                                <tr>
	                                                    <th>입금은행</th>
	                                                    <td >
															<select id="payBankCd" name="payBankCd"></select>
														</td>
	                                                    <th >입금계좌</th>
	                                                    <td><input type="text" name="payAcct" id="payAcct" value="" maxlength="20" ></td>
	                                                </tr>
	                                            </tbody>
	                                        </table>
	                                    </div>
	                                </div>
	                            </article>

	                           <div class="btn-wrap flex-box jc-center gap-15">
								   <button type="button" class="btn-color sub-btn2" onclick="fnSave();">신청</button>
								   <button type="button" class="btn-white sub-btn2" onclick="fnRepage();">목록</button>
							   </div>

                            </div>
                        </section>
                        </form>
                    </div>
                </div>
            </div>
        </div>
</html>