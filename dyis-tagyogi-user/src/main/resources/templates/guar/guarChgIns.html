<!--
	시스템구분 : 홈페이지 (콘텐츠 화면 처리 영역)
	파일정보 : guarChgIns.html
	파일명 : guarChgIns.html
	업무명 : 홈페이지 (콘텐츠 화면 처리 영역)
	생성자 : 권다슬
	생성일 : 2023.08.29
-->
<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" xml:lang="ko">
	<th:block th:layout="comjs">
			<script th:src="@{/js/guarCom.js}"></script>
		</th:block>
	<script th:inline="javascript">
		/*<![CDATA[*/
		var codeList = /*[[${codeList}]]*/; //공통코드
		var guarType = /*[[${paramMap.refVal}]]*/; //메뉴참조값 (보증상품)
		var menuCd = /*[[${menuInfo.menuCd}]]*/;	//guarCom.fnCalcCommAmt 사용
		var guarChgYn = "Y"; //추가보증여부

		//화면 초기화 처리 호출v
		$(document).ready(function(){
			//lnb 세팅함수
			fnPageLnbSet(/*[[${menuInfo}]]*/, /*[[${paramMap.listNm}]]*/); //lnb세팅

			guarCom.fnGuarIssueCdSelectBox();	//신청방법

			//동적 첨부파일 (다건)
			com.fnIbsUpload($("#docFile"));

			//보증 정보 화면 설정(guar/comGuarReq.html)
			fnGuarContrInputSet();

			//기존 보증정보 조회
			fnSelectGuarChg();
		});

		//기존 보증정보 조회
		var fnSelectGuarChg = function(){
			//보증변경등록 전용 데이터로 수정(심사승인자 조회 추가, 첨부파일 제외)
			obj = {url:"/guarChg/selectGuarChg.do", formId:"saveFrm", callBack:fnSelectGuarChgCallback, msgYn:"N", sessYn:"Y", loadYn:"Y"};
			com.fnAjaxPost(obj);
		}

		//보증정보 조회 콜백
		var fnSelectGuarChgCallback = function(resData){
			//console.log(resData);

			//약정정보 확인
			if(com.fnIsEmpty(resData.contrList)){
				alert("보증약정 정보가 존재하지 않습니다.");
				fnPage(/*[[${paramMap.returnPage}]]*/)
				return;
			}

			//0. 조합원 조기경보 체크
			guarCom.fnCheckMembCretop(resData.memb.membCretop, /*[[${paramMap.returnPage}]]*/);

			//1-1. 조합원(조합원 값 hidden에 저장을 위해 area 생략)
			com.fnSetKeyVal(resData.memb);
			$("#contrNo").val(resData.memb.guarContrNo);			//약정번호

			//1-2. 약정구분 selectBox 생성(comGuarMemb.html)
			fnContrTypeSelectBoxSet(resData.contrList);

			//1-3. 조합원(약정정보)
			com.fnSetKeyVal(resData.contr, "area_comGuarMemb");
			$("#finalGrade").val(resData.contr.finalGrade);			//신용도
			$("#contrType").val(resData.contr.contrType);			//약정구분

			//1-4. 조합원(보증한도, 보증사용액, 보증가능액)
			com.fnSetKeyVal(resData.contrLimit, "area_comGuarMemb");

			//2. 보증신청정보(신청자 selectBox)
			guarCom.fnSelCpSelectBox(resData.persList, resData.guar.reqNm); //전체
			if(!com.fnIsEmpty(resData.guar.reqType)){	//직접입력이 아니면 readonly 처리
				$("#reqNm").prop("readonly", true);		//신청자명
				$("#reqTel").prop("readonly", true);	//신청자연락처
			}

			//3-1. 보증정보
			com.fnSetKeyVal(resData.guar);
			uptCheckValGuar(resData.guar);	//체크박스 값체크 (comGuarReq.html)

			//3-2. g2b관련
			guarCom.fnGuarIssueChg($("#guarIssueCd").val());	//해당사항없음 or input + 검색 조회 버튼
			if(!com.fnIsEmpty(resData.guar.publicNo))	$("#g2bYn").val("Y");	//기존 계약번호가 있으면 등록때 검색했다고 판단
			$("#checkedPublicNo").val(resData.guar.publicNo);	//계약번호 변경 체크를 위해 저장

			//3-3. 기존보증 데이터 저장을 위해 이전 보증번호에 set
			$("#befGuarNo").val(resData.guar.guarNo);		//기존보증번호
			$("#befGuarSeq").val(resData.guar.guarSeq);		//기존보증서순번
			$("#befMembNo").val(resData.guar.membNo);		//기존조합원번호
			$("#befGuarBegDt").val(resData.guar.guarBegDt);	//기존보증시작일
			$("#befGuarExpDt").val(resData.guar.guarExpDt);	//기존보증종료일
			$("#befGuarDays").val(resData.guar.guarDays);	//기존보증기간
			$("#befGuarAmt").val(resData.guar.guarAmt);		//기존보증금액
			$("#befCommRate").val(resData.guar.commRate);	//변경전요율
			$("#befContrAmt").val(resData.guar.contrAmt)	//기존계약금액
			$("#befRepayAmt").val(resData.guar.repayAmt)	//기존선금급금액
			$("#befDocNo").val(resData.guar.docNo);			//기존보증서번호
			$("#reqDt").val(/*[[${today}]]*/);	//신청일자 오늘로(guarCom.fnSelectGuarRate 보증료 조회 전에 set 필수)
            $("#guarClassCd").val(""); //변경구분 초기화
			//3. 요율정보(기존 보증 요율 쓰는거 확인)
			//var paramData = {data: resData.comRate};
			//guarCom.fnSelectRateNoCalcCallBack(paramData);
		}

		//저장
		var fnSave = function(){
			//필수체크
			var valChks = ["reqNm","reqTel","reqDt","contrAmt","guarRate","guarAmt","orderNm","servNm","guarBegDt","guarExpDt","guarAddDays"];	//"selCp",

			if(guarType !== "11")						valChks.push(...["contrBegDt", "contrExpDt", "contrDays"]);
			if(guarType === "11" || guarType === "13")	valChks.push(...["releDt"]);
			if(guarType === "13")						valChks.push(...["releBegDt", "releEndDt", "releDays"]);
			if(guarType !== "14")						valChks.push(...["contrDt"]);
			if(guarType === "14")						valChks.push(...["repayAmt"]);

			if(com.fnValChk(valChks)){

				if($("#contrNo").val() === ""){
			        alert("해당보증 약정 정보가 존재하지 않습니다.");
			        return;
			    }

			    //보증금액
				if(guarCom.fnToNumber($("#guarAmt").val()) > guarCom.fnToNumber($("#ele_remainAmt").text()) + guarCom.fnToNumber($("#befGuarAmt").val())  ) {
			        alert("보증금액이 보증가능금액을 초과하였습니다.");
			        return;
			    }

			    //출자면제보증한도체크
			    if($("#contrType").val() === "13" && guarCom.fnToNumber($("#guarAmt").val()) > guarCom.fnToNumber($("#exemLimitAmt").val())) {
			    	alert("보증금액이 출자면제약정 건당 한도액(" + com.addComma($("#exemLimitAmt").val()) + ")을 초과하였습니다.");
			        return;
			    }


				if($("#guarIssueCd option:selected").val() === "G" ) {
					if($("#g2bYn").val() !== "Y"){
						alert("전자보증정보를 조회 하십시오.");
						return;
					}

					if($("#checkedPublicNo").val() !== $("#publicNo").val()){
						alert("계약번호가 변경 입력되었습니다.(조회된 계약번호: "+$("#checkedPublicNo").val()+")\n 다시 조회 하시거나 이전 계약번호로 변경하십시오.");
						return;
					}
			    }

				if(confirm("입력하신 "+ guarCom.fnSelectGuarTypeNm(guarType) + " 정보를 신청하시겠습니까?")){
					//전자서명 처리
					var guarBegDt = $("#guarBegDt").val().split("-");	//보증기간(시작)
			        var guarExpDt = $("#guarExpDt").val().split("-");	//보증기간(종료)
			        var reqDt	  = $("#reqDt").val().split("-");		//신청일

					var chgCont = "";	//변경구분
					$("#ele_chgDescType").find("input[type=checkbox]:checked").each(function(){
						if(chgCont !== "")	chgCont += ",";
						chgCont += $(this).data("text");
					});

					let plan =  "보증 변경 신청" 	+ "\n" +
								"조합원명 : " + $("#membNm").val()	+ "\n" +
								"보증번호 : " + $("#guarNo").val() + "\n" +
								"변경구분 : " + chgCont + "\n" +
								"계약기간 : " 	+ guarBegDt[0]+"년 "+guarBegDt[1]+"월 "+guarBegDt[2] +"일 ~ "+guarExpDt[0]+"년 "+guarExpDt[1]+"월 "+guarExpDt[2] +"일까지 " 	+ "\n" +
								"계약일자 : "	+ reqDt[0]+"년 "+reqDt[1]+"월 "+reqDt[2] +"일" + "\n" +
								"계약금액 : "	+ $("#contrAmt").val() 	+ "\n" +
								"보증금율 : "	+ $("#guarRate").val() + " %\n" +
								"신청일자 : " + $("#reqDt").val() + "\n" +
								"신청자명 : " + $("#reqNm").val();

					alert(plan);
					param = {plan:plan, idn:/*[[${session.bizNo}]]*/};
					com.fnCertSign(param); //전자서명 처리

					//등록 테스트
					//var test = {signData: "test"};
					//fnCertSingCallBack(test);	//테스트
				}
			}
		}

		//서명 콜백(전자서명 포함 저장)
		var fnCertSingCallBack = function(resData){
			//console.log(resData);
			$("#signedGuarCont").val(resData.signData);

			obj = {url:"/guarChg/insertGuarChg.do", formId:"saveFrm", fileId:"docFile", callBack:fnSaveCallBack, msgYn:"Y", sessYn:"Y", loadYn:"Y"};
			com.fnAjaxMulti(obj);
		}

		//저장 콜백
		var fnSaveCallBack = function(resData){
			fnPage('2030201');	//신청 목록으로 이동
		}

		//이전보증정보 버튼 이벤트
		var fnBefGuarOpen = function (){
		    $("#befInfo").toggle();
		}

		//목록 버튼 클릭 이벤트
		var fnGoListPage = function(){
			fnPage(/*[[${paramMap.returnPage}]]*/);
		}

		/*]]>*/
	</script>
        <div class="main-top sub">
			<ul class="inner">
                <li class="move1"></li>
                <li class="move2"></li>
                <li class="move3"></li>
                <li class="move4"></li>
                <li class="move5"></li>
            </ul>
        </div>
        <div class="content-wrap">
            <div class="inner">
                <div class="content-box flex-box jc-between">
                    <!-- 업무 안내 영역 -->
                    <div id="lnb" class="lnb-wrap">
                        <h3 class="ko-bold h3-txt"></h3>

                    </div>

                    <!-- 업무 안내 영역 끝 -->
                    <div class="content-main">
						<!-- 경로 영역 시작 -->
                        <div th:insert="~{/fragments/subTitle}"></div>
                        <!-- 경로 영역 끝 -->
                        <form name="saveFrm" id="saveFrm" onSubmit="return false">
							<input type="hidden" th:name="_csrf" th:value="${_csrf?.token}"/>
							<!-- 조회용 -->
							<input type="hidden" name="membNo" 			id="membNo" 	  th:value="${session.membNo}"/>
							<input type="hidden" name="sMembNo" 		id="sMembNo" 	  th:value="${session.membNo}"/>
							<input type="hidden" name="atthType" 		id="atthType" 	  th:value="${menuInfo.atthType}"/>
							<input type="hidden" name="guarNo" 			id="guarNo" 	  th:value="${paramMap.guarNo}"/>
							<input type="hidden" name="contrNo" 		id="contrNo" 	  th:value="${paramMap.contrNo}"/>
							<input type="hidden" name="guarType" 		id="guarType" 	  th:value="${paramMap.refVal}"/>
							<input type="hidden" name="befCommType" 	id="befCommType"  value="R"/>	<!-- selectGuarChg에서 사용됨(BEF_COMM_AMT 계산) -->
							<input type="hidden" name="sGuarType" 		id="sGuarType" 	  th:value="${paramMap.refVal}"/>
							<input type="hidden" name="sRefContrNoYn" 	id="sRefContrNoYn"   value="Y"/>	<!-- 참조약정 제외 조회 -->

							<!-- 데이터 저장용 -->
							<input type="hidden" name="membNm"       	id="membNm"       value="" />
                			<input type="hidden" name="ceoNm"        	id="ceoNm"        value="" />
							<input type="hidden" name="commRate"     	id="commRate"	  value="" />
			                <input type="hidden" name="orgRate"      	id="orgRate"      value="" />
			                <input type="hidden" name="initGuarSeq"		id="initGuarSeq"  value="" />

			                <input type="hidden" name="finalGrade"   	id="finalGrade"	  value="" />
			                <input type="hidden" 						id="mortCnt"	  value="" />	<!-- 담보갯수 -->
               				<input type="hidden" name="exemLimitAmt" 	id="exemLimitAmt" value="" />	<!-- 출자면제보증한도 - 요율조회할때 가져옴 fnSelectRateNoCalcCallBack  -->
               				<!--<input type="hidden" name="contrType"   	id="contrType"	  value="" />-->  <!-- comGuarMemb으로 위치변경 -->

							<input type="hidden" name="initDocNo"  		id="initDocNo"    value="" />
							<input type="hidden" name="initReqDt"  		id="initReqDt"    value="" />	<!-- 최초 신청일 -->
               				<input type="hidden" name="guarStat"		id="guarStat" 	  value=""/> 	<!-- 보증상태 : GR02 -->
							<input type="hidden" name="guarClassCd"		id="guarClassCd"  value=""/> 	<!-- 신청유형 : GR03 - 최초 -->
							<input type="hidden" name="guarReqCd"		id="guarReqCd" 	  value=""/> 	<!-- 신청유형 : GR04 - 신규 -->
							<input type="hidden" name="reqType" 		id="reqType"/> 					<!-- 신청유형 -->
							<input type="hidden" name="reqSeq"  		id="reqSeq"/> 					<!-- 신청순번 -->
							<input type="hidden" name="signedGuarCont"	id="signedGuarCont"	/>			<!-- 전자서명 -->

							<input type="hidden" name="befGuarNo"  		id="befGuarNo"	  value="" />
							<input type="hidden" name="befGuarSeq"    	id="befGuarSeq"   value="" />
							<input type="hidden" name="befMembNo"     	id="befMembNo"    value="" />
							<input type="hidden" name="befGuarBegDt"  	id="befGuarBegDt" value="" />
                            <input type="hidden" name="befGuarExpDt"  	id="befGuarExpDt" value="" />
                            <input type="hidden" name="befGuarDays"    	id="befGuarDays"  value="" />
                            <input type="hidden" name="befGuarAmt"  	id="befGuarAmt"	  value="" />
                            <input type="hidden" name="befCommRate"  	id="befCommRate"  value="" />
							<input type="hidden" name="befContrAmt"  	id="befContrAmt"  value="" />
							<input type="hidden" name="befRepayAmt"  	id="befRepayAmt"  value="" />
							<input type="hidden" name="befDocNo"  		id="befDocNo"	  value="" />

                            <input type="hidden" name="befCommAmt"    	id="befCommAmt"   value="" />
                            <input type="hidden" name="commAmt"    		id="commAmt"   value="" />
                            <input type="hidden" name="commCalc"  		id="commCalc"/> 				<!-- 보증료 산식 -->
							<input type="hidden" name="calcCommAmt"  	id="calcCommAmt"/> 				<!-- 계산 보증료 -->
                            <input type="hidden" name="payPreDt"  		id="payPreDt"/> 				<!-- guarCom.fnGetMinCommAmt -->
                            <!--<input type="hidden" name="modCommAmt"    	id="modCommAmt"   value="" />-->
                            <!--<input type="hidden" name="retCommAmt"    	id="retCommAmt"   value="" />-->

							<input type="hidden" name="chgCnt" 			id="chgCnt" />		<!-- 변경차수 -->
							<input type="hidden" name="guarClassCont"  	id="guarClassCont"/> 			<!-- 보증문구 -->

							<input type="hidden" name="g2bYn"			id="g2bYn" />				<!-- 조회여부 -->
							<input type="hidden" name="checkedPublicNo"	id="checkedPublicNo" />		<!-- 적용눌러서 확인된 계약번호 -->

	                        <section id="content" class="content">
	                            <!-- 여기서부터 content -->
	                            <div>
									<!-- 조합원 및 약정정보 -->
	                                <article id="area_membInfo">
										<th:block th:include="guar/comGuarMemb :: type(search)"></th:block>
	                                </article>

	                                <article>
	                                    <p class="title-dept1">보증서 신청정보</p>
	                                    <div class="table-wrap info">
	                                        <div class="table-scroll">
	                                            <table summary="보증서 신청정보">
	                                                <colgroup>
	                                                    <col width="13%">
								                        <col width="39%">
								                        <col width="13%">
								                        <col width="35%">
	                                                </colgroup>
	                                                <tbody>
	                                                    <tr>
	                                                        <th>신청유형</th>
	                                                        <td>변경신청</td>
	                                                        <th>처리상태</th>
	                                                        <td>신청</td>
	                                                    </tr>
	                                                    <tr>
	                                                        <th>신청방법</th>
	                                                        <td><select name="guarIssueCd" id="guarIssueCd" title="발급구분" style="width:120px" onchange="guarCom.fnGuarIssueChg(this.value);"></select></td>
	                                                        <th>계약번호</th>
	                                                        <td>
																<div id="ele_g2bNone">해당사항없음</div>
																<div id="ele_g2b" style="display:none">
																	<input type="text" name="publicNo" id="publicNo" maxlength="30" style="width:200px;" />
																	<button type="button" name="btnG2b" id="btnG2b" class="address-btn3" onclick="guarCom.fnG2bSearch()"></button>
																</div>
															</td>
	                                                    </tr>
	                                                    <tr>
	                                                        <th><span class="reqMark">*</span>신청자명</th>
	                                                        <td>
																<select name="selCp" id="selCp" title="신청자" style="width:150px"></select>
																<input type="text" name="reqNm" id="reqNm" title="신청자명" style="width:120px" maxlength="20"/>
															</td>
	                                                        <th><span class="reqMark">*</span>신청자연락처</th>
	                                                        <td><input type="text" name="reqTel" id="reqTel" title="신청자연락처" style="width:130px" maxlength="13" onkeyup="com.fnOnlyNum(this);com.makeTelNo(this)"/></td>
	                                                    </tr>
														<tr>
									                        <th>최초보증서</th>
									                        <td><span id="ele_initDocNo"></span></td>
									                        <th>이전보증정보</th>
									                        <td><button type="button" class="sub-btn1 btn-black" onclick="fnBefGuarOpen();">상세보기</button></td>
									                    </tr>
									                    <tr>
									                        <th>변경구분</th>
									                        <td colspan="3">
									                            <div id="ele_chgDescType" title="변경">
																	<input type="checkbox" id="chgDtUp" value="2" data-text="기간연장" onclick="guarCom.fnDetectChg(this.id,'chgDtDn')" /> 기간연장
												                    <input type="checkbox" id="chgDtDn" value="3" data-text="기간단축" onclick="guarCom.fnDetectChg(this.id,'chgDtUp')" /> 기간단축
												                    <input type="checkbox" id="chgAmtUp" value="4" data-text="금액증액" onclick="guarCom.fnDetectChg(this.id,'chgAmtDn')" /> 금액증액
												                    <input type="checkbox" id="chgAmtDn" value="5" data-text="금액감액" onclick="guarCom.fnDetectChg(this.id,'chgAmtUp')" /> 금액감액
																</div>
									                        </td>
									                    </tr>
	                                                </tbody>
	                                            </table>
	                                        </div>
	                                    </div>
	                                </article>

	                                <article id="befInfo" style="display:none;">
	                                    <p class="title-dept1">이전보증정보</p>
	                                    <div class="table-wrap info">
	                                        <div class="table-scroll">
	                                            <table summary="이전보증정보">
	                                                <colgroup>
	                                                    <col width="13%">
								                        <col width="39%">
								                        <col width="13%">
								                        <col width="35%">
	                                                </colgroup>
	                                                <tbody>
	                                                     <tr>
									                        <th>보증번호</th>
									                        <td><span id="ele_guarNo"></span></td>
									                        <th>이전보증서</th>
									                        <td><span id="ele_docNo"></span></td>
									                    </tr>
									                    <tr>
									                        <th>기존계약금액</th>
									                        <td><span id="ele_contrAmt"></span></td>
									                        <th>기존보증금액</th>
									                        <td><span id="ele_guarAmt"></span></td>
									                    </tr>
									                    <tr>
									                        <th>기존보증기간</th>
									                        <td colspan="3">
																<span id="ele_guarBegDt"></span><span>&nbsp;~&nbsp;</span><span id="ele_guarExpDt"></span>&nbsp;(<span id="ele_guarDays"></span>일)
															</td>
									                    </tr>
	                                                </tbody>
                                                </table>
                                            </div>
                                        </div>
	                                </article>

	                                <article>
										<th:block th:include="guar/comGuarReq"></th:block> <!-- 계약정보 -->
	                                </article>

	                                <article>
										<p class="title-dept1"><span id="txt_dtl"></span>추가보증 정보</p>
										<div class="table-wrap info">
								            <div class="table-scroll">
								                <table summary="추가보증 정보">
													<colgroup>
														<col width="13%">
								                        <col width="39%">
								                        <col width="13%">
								                        <col width="35%">
													</colgroup>
													<tbody>
														<tr>
															<th>변경분</br>표시구분</th>
															<td colspan="3">
											                    <input type="checkbox" name="chgDispYn" value="Y" onclick="guarCom.fnChgDispYn(this.value);" checked/> 변경분 표시
					                    						<input type="checkbox" name="chgDispYn" value="N" onclick="guarCom.fnChgDispYn(this.value);"/> 전체표시
															</td>
														</tr>
														<tr>
															<th>변경보증기간</th>
															<td>
																<div class="flex-box al-center gap-5">
																	<input type="text" name="chgGuarBegDt" id="chgGuarBegDt" title="시작일" maxlength="10" value="" readonly/>~
																	<input type="text" name="chgGuarExpDt" id="chgGuarExpDt" title="종료일" maxlength="10" value="" readonly/>
												                    (<input type="text" name="chgGuarDays" id="chgGuarDays" maxlength="4" style="width:60px" value="" readonly/> 일)
											                    </div>
															</td>
															<th>변경보증금액</th>
															<td><input type="text" name="chgGuarAmt" id="chgGuarAmt" value="" size="13" style="width:130px" onkeyup="com.fnOnlyNum(this);makeComma(this);" readonly /></td>
														</tr>
													</tbody>
												</table>
											</div>
										</div>
									</article>

	                                <article>
	                                    <p class="title-dept1">첨부파일</p>
										<div id="docFile" style="height:140px;"></div>
	                                </article>

	                                <div class="btn-wrap flex-box jc-end gap-10 m-col">
	                                    <button type="button" class="sub-btn2 btn-color" onclick="fnSave()">신청</button>
	                                    <button type="button" class="sub-btn2 btn-white" onclick="fnGoListPage()">목록</button>
	                                </div>
	                            </div>
	                        </section>
                        </form>
                    </div>
                </div>
            </div>
        </div>
</html>