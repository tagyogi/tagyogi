<!--
	시스템구분 : 홈페이지 (콘텐츠 화면 처리 영역)
	파일정보 : invtMortReqIns.html
	파일명 : invtMortReqIns.html
	업무명 : 홈페이지 (콘텐츠 화면 처리 영역)
	생성자 : 변성균
	생성일 : 2023.06.21
-->
<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" xml:lang="ko">
	
	<script th:inline="javascript">
		/*<![CDATA[*/
		
		//화면 초기화 처리 호출
		$(document).ready(function(){
			//lnb 세팅함수
			fnPageLnbSet(/*[[${menuInfo}]]*/); //lnb세팅
			
			fnSerch();
		});
		
		var fnSerch = function(){
			obj = {url:"/invtReq/selectInvtMortBillReqList.do", formId:"serchFrm", callBack:fnSerchCallBack, msgYn:"N", sessYn:"Y", loadYn:"Y"};
			com.fnAjaxPost(obj);
		}
		
		var fnSerchCallBack = function(resData){
			console.log(resData.data);
			
			$("#ele_invtMort").empty();//초기화
			
			if(resData.data.length === 0) $("#ele_invtMort").append('<tr><td colspan=6">정보가 없습니다.</td></tr>');
			
			$.each(resData.data, function(index, item) {
				var html  = '<tr>';
					if(item.mortYn === "Y"){
						html += '<td class="alignC"><input type="checkbox" name="billSeq" id="billSeq'+ Number(index + 1) + '" value="'+ item.billNo + '" disabled="disabled"></td>'; //체크
					}else{
						html += '<td class="alignC"><input type="checkbox" name="billSeq" id="billSeq'+ Number(index + 1) + '" value="'+ item.billNo + '" ></td>'; //체크
					}
					html += '<td class="alignC" id="">'+ Number(index + 1) + '</td>'; //순번
					html += '<td class="alignC">'+ item.billTypeNm +'</td>'; //권종
					html += '<td class="alignC">'+ com.fnDateFormat(item.investDt) + '</td>'; //출자일자
					html += '<td class="alignR">'+ com.addComma(item.billAmt) +'원</td>'; //증권금액
					html += '<td class="alignC">'+ item.mortYnNm +'</td>'; //처리상태
					html += '</tr>';
					
				$("#ele_invtMort").append(html);
			});
		}
		
		//담보신청
		var fnMort = function(){
			
			var selectedRows = [];//선택된 row값 세팅
			
			$("input[name='billSeq']:checked").each(function() {
		        var row = {billNo: $(this).val(), mortYn: "Y", mortDt: /*[[${today}]]*/, signedCont: $("#signedCont").val(), membNo: $("#sMembNo").val()};
	        	selectedRows.push(row);
	   		});

			var param = {selectedRows: selectedRows};
			alert(JSON.stringify(selectedRows));
		    
			obj = {url:"/invtReq/updateInvtMortReq.do", param:param, callBack:fnSerch, msgYn:"Y", sessYn:"Y", loadYn:"Y"};
			com.fnAjaxDef(obj);
		}
		
		//담보신청 필수체크, 전자서명
		var fnSave = function(){
			if($("input[name='billSeq']:checkbox:checked").length === 0){
		        alert("출자증권을 선택해주십시오.");
		        return;
		    }
		    
			if(confirm("출자담보를 신청 하시겠습니까?")){
				var plan = ""; //인증서 내용
				
				//인증서 내용
				var billSeqs = $('[name=billSeq]:checked').map(function () { return this.value; }).get();
		        var membNo = $("#sMembNo").val();
		        var day = /*[[${today}]]*/;
		        	day = day.split("-");
		        alert(day);
		
		        plan = "신청일자 : " + day[0] + "년 "+day[1] + "월 " + day[2] + "일"
		                + "\n종별순번(담보번호) : " +  billSeqs
		                + "\n조합원번호 : " + membNo;
				
				alert(plan);								
				param = {plan:plan, idn:""};
				com.fnCertSign(param); //전자서명 처리
				
				//fnCertSingCallBack();
			}
		}
		
		//전자서명 콜백
		var fnCertSingCallBack = function(){
			fnMort();//담보신청
		}
		
		
		/*]]>*/
	</script>
        <div class="main-top sub">
			<ul class="inner">
                <li class="move1"></li>
                <li class="move2"></li>
                <li class="move3"></li>
                <li class="move4"></li>
                <li class="move5"></li>
            </ul>
        </div>
        <div class="content-wrap">
            <div class="inner">
                <div class="content-box flex-box jc-between">
                    <!-- 업무 안내 영역 -->
                    <div id="lnb" class="lnb-wrap">
                        <h3 class="ko-bold h3-txt"></h3>
                        
                    </div>

                    <!-- 업무 안내 영역 끝 -->
                    <div class="content-main">
						<!-- 경로 영역 시작 -->
                        <div th:insert="~{/fragments/subTitle}"></div>
                        <!-- 경로 영역 끝 -->
                        <form name="serchFrm" id="serchFrm" onSubmit="return false">
						<input type="hidden" th:name="_csrf" th:value="${_csrf?.token}"/>
						<input type="hidden" name="mortDt" id="mortDt" value=""/>
						<input type="hidden" name="signedCont" id="signedCont" value=""/>
						<input type="hidden" name="sMembNo" id="sMembNo" th:value="${session.membNo}"/>
                        <section id="content" class="content">
                            <!-- 여기서부터 content -->
                            <div>
                                <div class="alignR mb20">
                                    <button type="button" class="sub-btn btn-black onlyPc" onClick="fnSave()">설정</button>
                                </div>
                                <article>
                                    <div class="table-wrap board">
                                        <div class="table-scroll v2">
                                            <table class="border">
												<colgroup>
                                                    <col style="width:7%;">
                                                    <col style="width:7%;">
                                                    <col style="width:15%;">
                                                    <col style="width:20%;">
                                                    <col style="width:20%;">
                                                    <col style="width:12%;">
                                                </colgroup>
                                                <thead class="back-gray">
                                                    <tr>
                                                        <th scope="col">체크</th>
                                                        <th scope="col">번호</th>
                                                        <th scope="col">권종</th>
                                                        <th scope="col">출자일자</th>
                                                        <th scope="col">증권금액</th>
                                                        <th scope="col">비고</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="ele_invtMort"></tbody>
                                            </table>
                                        </div>
                                    </div>
                                </article>
                            </div>
                        </section>
                        </form>
                    </div>
                </div>
            </div>
        </div>
</html>